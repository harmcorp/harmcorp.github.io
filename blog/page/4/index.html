
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://harmcorp.github.io/blog/page/4/">
      
      
      
        <link rel="next" href="../../tags/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.2">
    
    
      
        <title>this is blog index! - HARM CORP</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.d7758b05.min.css">
      
      


  
  
    
    
      
    
    
  
  
  <style>.md-tag.md-tag--rabbitmq{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M23.035 9.601h-7.677a.956.956 0 0 1-.962-.962V.962a.956.956 0 0 0-.962-.956H10.56a.956.956 0 0 0-.962.956V8.64a.956.956 0 0 1-.962.962H5.762a.956.956 0 0 1-.961-.962V.962A.956.956 0 0 0 3.839 0H.959a.956.956 0 0 0-.956.962v22.076A.956.956 0 0 0 .965 24h22.07a.956.956 0 0 0 .962-.962V10.58a.956.956 0 0 0-.962-.98zm-3.86 8.152a1.437 1.437 0 0 1-1.437 1.443h-1.924a1.437 1.437 0 0 1-1.436-1.443v-1.917a1.437 1.437 0 0 1 1.436-1.443h1.924a1.437 1.437 0 0 1 1.437 1.443z"/></svg>');}</style>

    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#this-is-blog-index" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="HARM CORP" class="md-header__button md-logo" aria-label="HARM CORP" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            HARM CORP
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              this is blog index!
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="HARM CORP" class="md-nav__button md-logo" aria-label="HARM CORP" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    HARM CORP
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Blog
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
      
    
  
  
    <li class="md-nav__item">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="../../" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    this is blog index!
    
  </span>
  

      </a>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tags
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_3" >
        
          
          <label class="md-nav__link" for="__nav_1_3" id="__nav_1_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Archive
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_3">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2025/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2025
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2019/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2019
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_4" >
        
          
          <label class="md-nav__link" for="__nav_1_4" id="__nav_1_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Categories
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_4">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/holidays/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Holidays
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="this-is-blog-index">this is blog index!</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-09-17 00:00:00+00:00">September 17, 2019</time></li>
        
        
          
          <li class="md-meta__item">
            
              9 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="common-command-on-linuxcentos"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/">Common Command on Linux(CentOS)</a></h2>
<h3 id="_1"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#_1">시스템 관련</a></h3>
<pre><code class="language-shell">echo $USER #echo currernt user

# os info
uname -a
# 위에 것으로 모를때. 대체로 모름
cat /etc/*release*
cat /etc/os-release

#os kernal version
uname -r

#os bit 1
uname -m

#os bit 2
getconf LONG_BIT

#os bit 3
arch

#cpu info
lscpu

#cpu count
nproc

#memory info
free

#--human-readable
free -h

#echo current path
pwd

history #사용한 명령어 히스토리
![line number] #히스토리의 해당 라인을 재실행

file -bi [CHECK_FILE_NAME] #파일의 캐릭터셋을 확인한다
#-b --brief                do not prepend filenames to output lines
#-i, --mime                 output MIME type strings (--mime-type and --mime-encoding)

ls #디렉토리 내용 확인

lscpu # cpu info
ulimit -n # open file number per core
</code></pre>
<h3 id="systemctl"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#systemctl">systemctl</a></h3>
<pre><code class="language-shell">systemctl start SERVICE_NAME.service
systemctl restart SERVICE_NAME.service
systemctl stop SERVICE_NAME.service
systemctl try-restart SERVICE_NAME.service #restart service when service is active
systemctl reload SERVICE_NAME.service
systemctl status SERVICE_NAME.service
systemctl cat SERVICE_NAME.service #check script?
# service list 확인
systemctl list-units
# service 자동 시작 확인/설정/해제
systemctl is-enabled SERVICE_NAME.service
systemctl enable SERVICE_NAME.service
systemctl disable SERVICE_NAME.service

</code></pre>
<h4 id="service"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#service">service 만들기</a></h4>
<pre><code class="language-shell">cd /etc/systemd/system
sudo vim &lt;YOUR-SERVICE-NAME&gt;.service
---
[Unit]
Description=&lt;YOUR-SERVICE-DESCRIPTION&gt;

[Service]
Type=simple
User=&lt;USER-NAME&gt;
Group=&lt;USER-GROUP&gt;
ExecStart=&lt;YOUR-SERVICE-EXECUTION-COMMAND&gt;
# ex : ExecStart=/bin/bash /home/irteam/actions-runner/run.sh
Restart=on-failure

[Install]
WantedBy=multi-user.target
---
sudo systemctl start &lt;YOUR-SERVICE-NAME&gt;
systemctl status &lt;YOUR-SERVICE-NAME&gt;
sudo systemctl enable &lt;YOUR-SERVICE-NAME&gt;.service
</code></pre>
<h3 id="user"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#user">User</a></h3>
<pre><code class="language-shell">cat /etc/passwd #check user
cat /etc/shadow #check user password
cat /etc/group #check group

su - [USER ID] #change user

useradd [OPTION] [USER ID]
#-m : make home dir
#-g : set group
passwd [USER ID] #set password
usermod [OPTION] [USER ID]
#-c [COMMENT] : add comment
#-g [GROUP NAME]: change primary group for user
#-G [GROUP NAME] : supplementary


groups [USER ID] #check user group
groupadd [GROUP NAME] #add group
groupdel [GROUP NAME] #delete group

gpasswd [GROUP NAME] #set group password
gpasswd -r [GROUP NAME] #remove group password
gpasswd -a [USER ID] [GROUP NAME] #add user to group

chown [OPTION] [OWNER:GROUP] [FILE]
chmod [OPTION] [PERMISSION] [FILE]
#-c : show change file
#-R : recursive work
# u = owner
# g = group
# o = other
# +, -, =
# r, w, x
chmod u=rwx,g=rx,o=rx ./token.txt
</code></pre>
<h3 id="process"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#process">process</a></h3>
<pre><code class="language-shell">$ ps -ef | grep nginx
</code></pre>
<h3 id="port"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#port">port</a></h3>
<h4 id="netstat"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#netstat">netstat</a></h4>
<pre><code class="language-shell"># options
# -l    Listening 중인 socket을 표시합니다.
# -p    socket을 사용하는 pid와 program 이름을 보여줍니다.
# -n    주소등을 number로 표시합니다(ex localhost를 127.0.0.1 로 표현)
# -i    interface의 정보를 보여줍니다.
# -t    tcp 사용 socket을 보여줍니다.
# -u    udp 사용 socket을 보여줍니다.
# -r    routing table을 보여줍니다.
# -a    listening과 non-listening 상태 모두를 보여줍니다.
# -c    매 초마다 명령을 계속적으로 실행합니다.
$ netstat -tunlp
</code></pre>
<p>mac os 에서는 좀 다르다</p>
<pre><code class="language-shell"># 열린 포트 확인
$ sudo  

# 열린 포트의 PID 확인
$ sudo lsof -i :3000
</code></pre>
<h4 id="firewall"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#firewall">firewall 방화벽</a></h4>
<ul>
<li>centos6 이하에서는 <code>iptables</code> 사용</li>
<li>centos7 에서는 <code>firewall-cmd</code> 사용</li>
</ul>
<h3 id="_2"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#_2">환경변수</a></h3>
<pre><code class="language-shell">env
export
</code></pre>
<h3 id="date"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#date">date</a></h3>
<ul>
<li>format 은 같으나, date add/substract 옵션이 linux/macos 다르다</li>
</ul>
<pre><code class="language-shell"># %Y : year
# %m : month
# %d : day
# %H : 24h
# %I : 12h
# %M : minute
# %S : second
# %p : AM/PM
# %s : timestamp

# linux
$ date
$ date -d '9 hour' &quot;+%Y-%m-%dT%H:%M:%S&quot;
$ date -d '9 hour ago' &quot;+%Y-%m-%dT%H:%M:%S&quot;
## milli seconds
$ date &quot;+%s&quot;

# mac
$ date
$ date -v-9H &quot;+%Y-%m-%dT%H:%M:%S&quot;

</code></pre>
<h3 id="_3"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#_3">압축</a></h3>
<pre><code class="language-shell">tar -cvzf [COMPRESSED NAME].tar.gz [COMPRESSING TARGET]
tar -xvzf [UNCOMPRESSING TARGET]
#v : 묶음/해제 과정을 화면에 표시
#c : 파일을 묶음
#x : 묶음을 해제
#z : gunzip을 사용
#f : 파일 이름을 지정
#p : 권한(permission)을 원본과 동일하게 유지

ln -s [SYMBOLIC LINK TARGET] [SYMBOLIC LINK NAME]

# 디렉토리와 하위 디렉토리 사이즈
du -h --apparent-size [TARGET LOCATION:DEFAULT .]
</code></pre>
<h4 id="alias"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#alias">자주쓰는 alias</a></h4>
<blockquote>
<p>alias 설정을 위해 <code>.bashrc</code> 수정</p>
</blockquote>
<pre><code class="language-shell">vi ~/.bashrc #modify .bashrc file
</code></pre>
<blockquote>
<p>alias 내용</p>
</blockquote>
<pre><code class="language-shell">alias cp='cp -i'
alias mv='mv -i'

alias compress='tar -cvzf'
alias uncompress='tar -xvzf'

alias start='systemctl start'
alias stop='systemctl stop'
alias status='systemctl status'
alias restart='systemctl restart'
alias reload='systemctl reload'

#for docker
alias dps='docker ps'
alias dimg='docker images'

#for public web server
alias connect_private_server='ssh -i /root/herdin-aws-study-copy.pem'
alias vim_nginx_conf='vim /etc/nginx/nginx.conf'
alias cd_nginx_conf='cd /etc/nginx'
alias cd_nginx_home='cd /usr/share/nginx/html'

#for private was server
alias cd_tomcat_home='cd /usr/share/tomcat'
</code></pre>
<blockquote>
<p>alias 설정 적용</p>
</blockquote>
<pre><code class="language-shell">source ~/.bashrc #modified .bashrc file apply
</code></pre>
<blockquote>
<p>alias 해제</p>
</blockquote>
<pre><code class="language-shell">unalias vim_nginx_conf
</code></pre>
<h3 id="_4"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#_4">명령어의 결과를 명령어안에 넣기</a></h3>
<p>백팃 이나 <code>"$()"</code> 를 사용하면된다</p>
<pre><code class="language-shell">$ echo `cat ~/deleteme/test.conf`
hello, config
$ echo &quot;$(cat ~/deleteme/test.conf)&quot;
hello, config
</code></pre>
<h3 id="set"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#set">set</a></h3>
<ul>
<li>-o pipefail 파이프 사용시 오류 코드(non-zero exit code) 승계</li>
<li>-e 오류가 발생하면 중단</li>
<li>+e 오류가 발생해도 진행</li>
<li>-u 설정되지 않은 변수를 사용하려고 하면 종료</li>
<li>-x 실행되는 명령어와 인수들을 출력</li>
</ul>
<h4 id="set-o-pipefail"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#set-o-pipefail">set -o pipefail</a></h4>
<p>exit code 승계</p>
<pre><code class="language-shell"># 아래와 같은 test1.sh 을 실행한다고 하면,
# /non/exsitent/file 가 없기 때문에 exit code 가 0 이 아니게되지만, 파이프 연산자에 의해 wc 가 정상 수행되면서 echo $? 에서 0 이 출력된다.
cat /non/exsitent/file | wc
echo $?

# 하지만 아래와 같이 set -o pipefail 를 넣으면, exit code 가 승계되어 echo $? 에서 1 이 출력된다.
set -o pipefail
cat /non/exsitent/file | wc
echo $?
</code></pre>
<h4 id="set-e"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#set-e">set -e</a></h4>
<p>오류가 발생하면 중단</p>
<pre><code class="language-shell"># 아래와 같은 test1.sh 를 실행하게되면, 중간에 오류가 나지만 hello, world 가 모두 출력 실행된다.
echo hello
cat asdfasdfasdf
echo world

# 하지만, set -e 를 함께 실행하면, hello 이후 오류가 나서 실행을 멈춘다.
set -e
echo hello
cat asdfasdfasdf
echo world
</code></pre>
<h3 id="process_1"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#process_1">Process.</a></h3>
<pre><code class="language-shell">ps #process show
#-e : show all
#-f : full format
#-l : long format
#-p : specific process
#-u : specific user process

kill #process kill
#-l : show SIGNAL list
1) SIGHUP       2) SIGINT       3) SIGQUIT      4) SIGILL       5) SIGTRAP
6) SIGABRT      7) SIGBUS       8) SIGFPE       9) SIGKILL     10) SIGUSR1
11) SIGSEGV     12) SIGUSR2     13) SIGPIPE     14) SIGALRM     15) SIGTERM
16) SIGSTKFLT   17) SIGCHLD     18) SIGCONT     19) SIGSTOP     20) SIGTSTP
21) SIGTTIN     22) SIGTTOU     23) SIGURG      24) SIGXCPU     25) SIGXFSZ
26) SIGVTALRM   27) SIGPROF     28) SIGWINCH    29) SIGIO       30) SIGPWR
31) SIGSYS      34) SIGRTMIN    35) SIGRTMIN+1  36) SIGRTMIN+2  37) SIGRTMIN+3
38) SIGRTMIN+4  39) SIGRTMIN+5  40) SIGRTMIN+6  41) SIGRTMIN+7  42) SIGRTMIN+8
43) SIGRTMIN+9  44) SIGRTMIN+10 45) SIGRTMIN+11 46) SIGRTMIN+12 47) SIGRTMIN+13
48) SIGRTMIN+14 49) SIGRTMIN+15 50) SIGRTMAX-14 51) SIGRTMAX-13 52) SIGRTMAX-12
53) SIGRTMAX-11 54) SIGRTMAX-10 55) SIGRTMAX-9  56) SIGRTMAX-8  57) SIGRTMAX-7
58) SIGRTMAX-6  59) SIGRTMAX-5  60) SIGRTMAX-4  61) SIGRTMAX-3  62) SIGRTMAX-2
63) SIGRTMAX-1  64) SIGRTMAX
#ex)
kill -SIGNAL PROCESS_ID
kill -2 123
kill -INT 123 #SIGINT - SIG
</code></pre>
<p>kill -9 ${PID} 를 사용하면 안되는 이유.</p>
<p>개발자가 시그널핸들러를 작성했는데도 불구하고 <code>SIGKILL</code>(9), <code>SIGSTOP</code>(19) 은 핸들러를 등록할 수 없는 시그널이기 때문에 사용을 지양해야 한다.</p>
<p>시그널 핸들러가 등록되지 않았을 때의 커널에 정의된 기본 행동 <a href="https://www.lesstif.com/pages/viewpage.action?pageId=12943674">출처</a></p>
<div id="pureTableHere"></div>
<script>
  util().genPureTable(
    'pureTableHere',
    ['SIGNAL', '기본 행동'],
    [
      ['TERM', '시그널을 수신한 프로세스 종료'],
      ['IGN', '시그널 무시'],
      ['CORE', '시그널을 수신한 프로세스를 종료하면서 코어 덤프(core dump) 파일 생성'],
      ['STOP', '시그널을 수신한 프로세스 정지'],
      ['CONT', '중지된 프로세스 재시작'],
    ]
  );
</script>

<h3 id="ls"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#ls">ls</a></h3>
<p>디렉토리 목록 출력</p>
<pre><code class="language-shell"># 시간순 정렬, 오름차순
$ ls -trl 
$ ls -trlh
# 파일크기 정렬, 오름차순
$ ls -Srlh
</code></pre>
<h3 id="df-disk-free"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#df-disk-free">df : disk free</a></h3>
<pre><code class="language-shell">#--human-readable
$ df -h
#--inodes
$ df -i
#--block-size=1K
$ df -k
</code></pre>
<h3 id="du-disk-usage"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#du-disk-usage">du : disk usage</a></h3>
<pre><code class="language-shell">$ du -sh *
$ du --summarize --human-readable *
# 해당 위치에서 폴더별 크기를 보여준다
$ du -smh * | sort -rh 
$ du -smh {location}
</code></pre>
<ul>
<li><a href="https://goateedev.tistory.com/181">참고</a></li>
</ul>
<h3 id="file-shrink"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#file-shrink">file shrink</a></h3>
<p>disk 가 full 났을때 파일 처리</p>
<pre><code class="language-shell"># 파일에 권한이 있다면 바로 실행
tail -n 100 access.log &gt; access.log
# 파일에 권한이 없는 경우
sudo bash -c &quot;tail -n 100 access.log &gt; access.log&quot;

# 또는 truncate 사용
</code></pre>
<h3 id="ln"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#ln">ln</a></h3>
<pre><code class="language-shell">$ ln -sf

</code></pre>
<ul>
<li><a href="https://jhnyang.tistory.com/269">temp</a></li>
</ul>
<h3 id="grep"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#grep">grep</a></h3>
<pre><code class="language-shell">$ grep [옵션][패턴][파일명]
</code></pre>
<h3 id="find"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#find"><a href="https://recipes4dev.tistory.com/156">find</a></a></h3>
<pre><code class="language-shell"># 파일명으로 찾을 경우
# find ${find-location} -name &quot;${target-file-name}&quot;
$ find / -name hello
</code></pre>
<h3 id="wc-word-count"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#wc-word-count">wc - word count?</a></h3>
<pre><code class="language-shell"># -l : lines
# -c : bytes
# -m : characters
# -w : word
$ wc -l
$ echo &quot;hello&quot; | wc -m
6
</code></pre>
<h3 id="cut"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#cut">cut</a></h3>
<p>문자열 자를때 사용</p>
<pre><code class="language-shell"># -b : byte
# -c : character
# -f : field
# -d : delimeter (default tab)
$ echo &quot;hello&quot; | cut -c1-4
$ echo &quot;hello\tworld&quot; | cut -f 1
</code></pre>
<h4 id="shellscript-while"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#shellscript-while">shellscript while</a></h4>
<p>docker stack deploy 이후, service 가 뜨는지 확인하기 위해 계속 치는게 귀찮아서 사용했다.</p>
<pre><code class="language-shell">$ while true
$ do
$ docker service ls
$ sleep 2
$ done
</code></pre>
<h4 id="bash-ps1-gen"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#bash-ps1-gen">Bash PS1 gen</a></h4>
<p><a href="http://ezprompt.net/">Bash Prompt gen</a></p>
<h3 id="base64"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#base64">base64</a></h3>
<ul>
<li><code>-d, --decode</code></li>
<li><code>-i, --input</code> (default)</li>
</ul>
<pre><code class="language-shell"># encode 했다가 decode 하기
$ echo &quot;hello world, epubaal&quot; | base64 | base64 -d
hello world, epubaal

# 파일을 사용하기
$ echo &quot;hello world, epubaal, in file&quot; &gt; test.txt
# 파일 내용 확인
$ cat test.txt                                   
hello world, epubaal, in file

# 파일내용 encode 해서 다른 파일에 넣기
$ base64 test.txt &gt; test-encode.txt
# 파일 내용 확인
$ cat test-encode.txt 
aGVsbG8gd29ybGQsIGVwdWJhYWwsIGluIGZpbGUK

# 파일내용 decode 해서 다른 파일에 넣기
$ base64 -d test-encode.txt &gt; test-decode.txt
# 파일 내용 확인
$ cat test-decode.txt
hello world, epubaal, in file
</code></pre>
<h3 id="more"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#more">more</a></h3>
<pre><code class="language-shell">$ more &lt;FILE_NAME&gt;
</code></pre>
<ul>
<li>화면 가득히 파일내용을 출력해준다</li>
<li><code>space bar</code> 를 누르면 파일에서 한줄씩 내려간다.</li>
<li><code>enter</code> 를 누르면 화면에서 한줄씩 내려간다.</li>
<li>현재보이는 내용이 전체 파일에서 몇 % 를 차지하는지 알려준다.</li>
<li><code>f</code> 를 누르면 forward 1페이지만큼 다음으로 간다</li>
<li><code>b</code> 를 누르면 backward 1페이지만큼 이전으로 간다</li>
</ul>
<h3 id="less"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#less">less</a></h3>
<p><code>more</code> 같은데 페이지단위로 볼 수 있고, 끝에서부터도 볼 수 있다.</p>
<pre><code class="language-shell">$ less &lt;FILE_NAME&gt;
$ less -N &lt;FILE_NAME&gt; # show line number

# 화살표키 위아래로 한줄씩이동
# space, f 로 한페이지 아래로 이동
# b 으로 한페이지 위로 이동
# G 로 끝으로 이동
# more 와 유사하게 `/` 로 검색
# q 로 종료
</code></pre>
<h3 id="tr"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#tr">tr</a></h3>
<ul>
<li>입력받은문자에서 특정문자를 자르거나 변경할때</li>
</ul>
<h3 id="sort"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#sort">sort</a></h3>
<ul>
<li>입력받은 라인을 정렬</li>
</ul>
<h3 id="uniq"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#uniq">uniq</a></h3>
<ul>
<li>입력받은 라인에서 중복을 제거</li>
<li>곁에있는 라인에서 중복을 제거하므로, sort 다음에 쓰인다.</li>
</ul>
<h3 id="comm"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#comm">comm</a></h3>
<p>두 파일을 비교한다</p>
<pre><code class="language-shell">$ comm [option] [file1] [file2]
# [option]
# -1 두개를 비교하여 파일 1에만 있는 것은 출력하지 않음
# -2 두개를 비교하여 파일 2에만 있는 것은 출력하지 않음
# -3 두개를 비교하여 파일 1과 파일 2에 모두 존재하는 라인은 출력하지 않음

</code></pre>
<h3 id="scp-ssh-secure-copy"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#scp-ssh-secure-copy">scp : ssh 기반의 secure copy 를 수행. 원격파일카피.</a></h3>
<pre><code class="language-shell"># r option for directory
scp -r &lt;local-file-location&gt; &lt;remote-id&gt;@&lt;remote-host&gt;:&lt;remote-file-location&gt;
scp -r &lt;remote-id&gt;@&lt;remote-host&gt;:&lt;remote-file-location&gt; &lt;local-file-location&gt;
scp -r epu@file.anmani.link:/home/remote-epu/tmp /Users/user/Downloads/tmp
</code></pre>
<h3 id="crontab"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#crontab">crontab</a></h3>
<pre><code class="language-shell"># 확인
crontab -l
# 편집
crontab -e
# 삭제
crontab -r
# *        *　　　   　*　　 　　　*　 　 　　*
# 분(0-59)　시간(0-23) 일(1-31) 월(1-12) 요일(0-7,[0,7:일요일])
</code></pre>
<ul>
<li><a href="https://jdm.kr/blog/2">참고</a></li>
</ul>
<h3 id="selinux"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#selinux">SELinux</a></h3>
<p><a href="{{ site.url }}/2019/08/27/selinux">SELinux 란?</a></p>
<pre><code class="language-shell">sestatus #selinux status
getenforce #selinux mode check
setenforce 0 #selinux mode set Permissive=0 [로그만남김], Enforcing=1 [selinux 적용]
tail -f /var/log/audit/audit.log #log

matchpathcon [FILE PATH] #check security context
chcon [OPTION] [CONTEXT FILE] #change context
#-t : type
#-R : recursive
</code></pre>
<h3 id="package-management"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#package-management">package management</a></h3>
<pre><code class="language-shell"># RHEL/CentOS
$ yum install package_name
# Ubuntu
$ apt install package_name
# Alpine
$ apk add package_name
# Debian
$ apk install package_name
# apt update &amp;&amp; apt install -y procps
# apt update &amp;&amp; apt install -y vim
# apt update &amp;&amp; apt install -y sudo
</code></pre>
<h3 id="yum"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#yum">yum</a></h3>
<p>레드햇 계열의 리눅스 배포판에서 사용하는 프로그램(패키지) 설치 관리 도구</p>
<h4 id="yum-repository"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#yum-repository">yum repository 활성화/비활성화</a></h4>
<pre><code class="language-shell"># base repository 의 상태를 확인
$ yum repolist base -v

# repo list 의 상태가 저장된 파일들이 있는곳
$ cd /etc/yum.repos.d

# 안에서 설정파일들의 enabled=0 를 변경한다. (0 비활성화, 1 활성화)
</code></pre>
<h3 id="traceroute"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#traceroute">traceroute</a></h3>
<pre><code class="language-shell">$ traceroute www.naver.com
traceroute: Warning: www.naver.com has multiple addresses; using 223.130.195.200
traceroute to www.naver.com.nheos.com (223.130.195.200), 64 hops max, 52 byte packets
 1  10.200.200.200 (10.200.200.200)  20.043 ms  4.234 ms  4.871 ms
 2  10.104.248.45 (10.104.248.45)  20.214 ms  4.501 ms  4.504 ms
 3  10.104.248.5 (10.104.248.5)  21.917 ms  5.678 ms  5.257 ms
 4  10.104.245.26 (10.104.245.26)  20.284 ms  5.247 ms
    10.104.245.22 (10.104.245.22)  19.672 ms
 5  10.104.240.49 (10.104.240.49)  20.054 ms
    10.104.241.47 (10.104.241.47)  20.204 ms
    10.104.241.49 (10.104.241.49)  23.500 ms
 6  223.130.195.200 (223.130.195.200)  19.518 ms  4.366 ms  4.473 ms
</code></pre>
<h3 id="ftpsftp"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#ftpsftp">ftp/sftp</a></h3>
<pre><code class="language-shell"># ftp ${ip}
# ftp ${ip} ${port}
$ ftp 1.22.333.444 8888


# sftp -P ${port} ${id}@${ip}
$ sftp -P 8888 id@1.22.333.444

$ sftp -P ${PORT_NUMBER} -oIdentityFile=/path/to/private/key user@hostname

# 접속 후
ls
pwd
get &lt;filename&gt;
</code></pre>
<h3 id="jdk"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#jdk">jdk 관련..</a></h3>
<h4 id="jvm-javaiotmpdir"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#jvm-javaiotmpdir">jvm 에서 사용하는 <code>java.io.tmpdir</code> 가 어딘지 확인해보고싶었다.</a></h4>
<pre><code class="language-shell"># 먼저 java 프로그램을 찾아서
$ ps -ef | grep java
# pid 를 jino 에 넣어준다
# jinfo ${pid}
$ jinfo 12345

Java System Properties:
#Fri Feb 04 15:55:52 KST 2022
awt.toolkit=sun.lwawt.macosx.LWCToolkit
java.specification.version=11
kotlinx.coroutines.debug=off
sun.cpu.isalist=
sun.jnu.encoding=UTF-8
sun.arch.data.model=64
idea.fatal.error.notification=disabled
sun.font.fontmanager=sun.font.CFontManager
pty4j.preferred.native.folder=/Applications/IntelliJ IDEA.app/Contents/lib/pty4j-native
java.vendor.url=https\://openjdk.java.net/
apple.awt.fileDialogForDirectories=true
sun.java2d.uiScale.enabled=true
sun.io.useCanonCaches=false
jna.tmpdir=/Users/user/Library/Caches/JetBrains/IntelliJIdea2021.2/tmp
sun.boot.library.path=/Applications/IntelliJ IDEA.app/Contents/jbr/Contents/Home/lib
jdk.debug=release
sun.awt.exception.handler=com.intellij.openapi.application.impl.AWTExceptionHandler
com.apple.mrj.application.live-resize=false
java.specification.vendor=Oracle Corporation
java.version.date=2021-04-20
java.home=/Applications/IntelliJ IDEA.app/Contents/jbr/Contents/Home
file.separator=/
java.vm.compressedOopsMode=Zero based
line.separator=\n
java.specification.name=Java Platform API Specification
java.vm.specification.vendor=Oracle Corporation
jdk.attach.allowAttachSelf=true
idea.home.path=/Applications/IntelliJ IDEA.app/Contents
pty4j.tmpdir=/Users/user/Library/Caches/JetBrains/IntelliJIdea2021.2/tmp
sun.management.compiler=HotSpot 64-Bit Tiered Compilers
java.runtime.version=11.0.11+9-b1504.16
apple.awt.fullscreencapturealldisplays=false
user.name=user
javax.swing.rebaseCssSizeMap=true
idea.paths.selector=IntelliJIdea2021.2
sun.java2d.pmoffscreen=false
sun.awt.noerasebackground=true
file.encoding=UTF-8
jnidispatch.path=/Users/user/Library/Caches/JetBrains/IntelliJIdea2021.2/tmp/jna7920715044168139379.tmp
idea.popup.weight=heavy
java.vendor.version=JBR-11.0.11.9-1504.16-jcef
jna.loaded=true
java.io.tmpdir=/var/folders/12/f2csmhbn7ll786vc8wvz26mw0000gn/T/
java.version=11.0.11
idea.xdebug.key=-Xdebug

</code></pre>
<p>찾았당 -&gt; java.io.tmpdir=/var/folders/12/f2csmhbn7ll786vc8wvz26mw0000gn/T/</p>
<h4 id="jar"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#jar">jar 파일 내용을 확인해 보고싶다</a></h4>
<pre><code class="language-shell">$ jar tf &lt;JAR FILE NAME&gt;
</code></pre>
<h3 id="openssl"><a class="toclink" href="../../2019/09/17/common-command-on-linuxcentos/#openssl">openssl</a></h3>
<pre><code class="language-shell"># host:port 로 유효기간 확인
openssl s_client -connect &lt;HOST&gt;:&lt;PORT&gt; -showcerts | openssl x509 -enddate
# 인증서 file 유효기간 확인
openssl x509 -in &lt;CERT-FILE&gt; -noout -dates
</code></pre>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-09-17 00:00:00+00:00">September 17, 2019</time></li>
        
        
          
          <li class="md-meta__item">
            
              6 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="vault"><a class="toclink" href="../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/">Vault 맛보기</a></h2>
<p><a href="https://www.vaultproject.io/docs/install/">공식 문서</a></p>
<h2 id="_1"><a class="toclink" href="../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#_1">설치부터 해보자</a></h2>
<h4 id="_2"><a class="toclink" href="../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#_2">다운을 받자</a></h4>
<p><code>/tools/vault</code> 폴더를 만들고 거기에 설치할 계획이다.<br />
<code>docker</code> 버전으로 기동을 한다고해도 <code>vault cli</code> 때문이라도 깔아놓자.</p>
<pre><code class="language-shell">#download vault 1.1.2
$ wget https://releases.hashicorp.com/vault/1.1.2/vault_1.1.2_linux_amd64.zip
$ mkdir /tools/vault
$ unzip vault_1.1.2_linux_amd64.zip -d /tools/vault
</code></pre>
<h4 id="_3"><a class="toclink" href="../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#_3">압축풀었으면 환경변수를 세팅하자.</a></h4>
<pre><code class="language-shell">#setting vault path
$ cd ~
$ vim .bashrc

#&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; editor start
export VAULT_HOME=/tools/vault
export PATH=${VAULT_HOME}:${PATH}
export VAULT_ADDR='http://127.0.0.1:8200'
export VAULT_ROOT_TOKEN=''
#&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; editor end

$ source .bashrc
</code></pre>
<h4 id="vault-cli"><a class="toclink" href="../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#vault-cli">설치가 잘되었는지 vault cli 를 사용해보자</a></h4>
<pre><code class="language-shell">#verifying the installation
$ vault
#set vault autocomplete to bash
$ vault -autocomplete-install
$ exec $SHELL
</code></pre>
<h4 id="_4"><a class="toclink" href="../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#_4">개발모드란게 있지만..</a></h4>
<pre><code class="language-shell">#run vault server dev mode
$ vault server -dev
</code></pre>
<blockquote>
<p>사용해본적은 없다.</p>
</blockquote>
<h4 id="_5"><a class="toclink" href="../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#_5">운영모드로 세팅해보자</a></h4>
<blockquote>
<p>config.hcl</p>
</blockquote>
<pre><code class="language-shell">storage &quot;file&quot; {
  path = &quot;/mnt/vault/data&quot;
}

listener &quot;tcp&quot; {
  address = &quot;0.0.0.0:8200&quot;
  tls_disable = false
}

ui = true
</code></pre>
<p><code>ui = true</code> 옵션을 넣었기 떄문에 <code>vault ui url = http://host.domain.name:8200/ui</code> 에 접속했을 경우 웹 페이지가 나와야한다.</p>
<h2 id="_6"><a class="toclink" href="../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#_6">세팅을 했으면 기동을 해보자</a></h2>
<ul>
<li><code>non-docker</code> 버전으로 아래와 같이 실행을 하던지,</li>
</ul>
<pre><code class="language-shell">$ vault server -config=config.hcl
$ vault operator init
</code></pre>
<ul>
<li><code>docker</code> 버전으로 아래와 같이 실행을 하자.</li>
</ul>
<pre><code class="language-shell">#config init
$ docker run
 --cap-add=IPC_LOCK
 -e 'VAULT_LOCAL_CONFIG={&quot;backend&quot;: {&quot;file&quot;: {&quot;path&quot;: &quot;/vault/file&quot;}}, &quot;listener&quot;: {&quot;tcp&quot;: { &quot;address&quot;: &quot;0.0.0.0:8200&quot;, &quot;tls_disable&quot;: &quot;true&quot;}}, &quot;ui&quot;: &quot;true&quot;, &quot;default_lease_ttl&quot;: &quot;168h&quot;, &quot;max_lease_ttl&quot;: &quot;720h&quot;}'
 -d
 -p 8200:8200
 --name=dev-vault
 docker.io/vault:1.1.2 server
</code></pre>
<h4 id="unseal"><a class="toclink" href="../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#unseal">Unseal 을 해보자</a></h4>
<p>초기에 vault 가 실행되거나 재기동이 되면 <code>sealed</code> 상태가 되어 사용할 수 없게 된다.<br />
이때 사용할 수 있는 명령은 <code>status</code>, <code>operator init</code> 뿐인듯.<br />
<code>unseal key</code> 5개 중 아무거나 3개로 unseal 하여 사용하자.<br />
<code>root key</code> 는 잘 숨겨놓자.</p>
<pre><code class="language-shell"># 아래키는 여러번 실행해본 docker 버전의 vault 의 키 중 하나이다.
Unseal Key 1: zmQlHaFap7yo/onSXDLGtzUQwz/cgNc3igd7dvSsPl9M
Unseal Key 2: 0R1XXjz2szSJW3q05eapTs2ST6npYsHROHEr0l1aMyez
Unseal Key 3: 5YwtvQcIP+VzX/TMkb0UDSaw+R9ZDftx3eDAmHn7Tn8Q
Unseal Key 4: 45mBEZsh4dC71EUq2SXgC7owz3NFx04cqaQEMlDp1Yqo
Unseal Key 5: HP18QROkknaL8ZAyMFfMZmBh/cxuKfUiq/Zx9nOlW8Bj

Initial Root Token: s.syVRoWESdXjZU0iaPDXROlEv

$ vault operator unseal
Unseal Key (will be hidden):
</code></pre>
<h2 id="_7"><a class="toclink" href="../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#_7">이제 설치 끝! 사용해보자</a></h2>
<h4 id="secret-engine"><a class="toclink" href="../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#secret-engine">secret engine 을 활성화 하자</a></h4>
<p>단순하게 사용할거니까 <code>KV Secrets Engine</code> 를 활성화 시킨다.<br />
버전이 두개가 있으므로 둘다 써보자.</p>
<blockquote>
<p>Version 1 과 Version 2 의 차이점은 K/V 의 버전 유무다. Version 2 는 K/V 셋의 버전을 관리해준다.</p>
</blockquote>
<pre><code class="language-shell">$ vault secrets enable -version=1 -path=my-secret1 kv
Success! Enabled the kv secrets engine at: my-secret1/

$ vault secrets enable -version=2 -path=my-secret2 kv
Success! Enabled the kv secrets engine at: my-secret2/
</code></pre>
<h4 id="secret-engine_1"><a class="toclink" href="../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#secret-engine_1">활성화한 secret engine 에 데이터를 써보자</a></h4>
<blockquote>
<p>Version 1 에선 <code>read/write</code> 또는 <code>kv get/put</code>명령어를 사용했지만, Version 2 에선 <code>kv get/put</code> 만 사용한다고 한다.</p>
</blockquote>
<p>먼저 <code>version 1</code> 부터</p>
<pre><code class="language-shell">$ vault write my-secret1/hello foo=bar
Success! Data written to: my-secret1/hello

$ vault read my-secret1/hello
Key                 Value
---                 -----
refresh_interval    168h
foo                 bar

$ vault write my-secret1/hello hello=world
Success! Data written to: my-secret1/hello

$ vault read my-secret1/hello
Key                 Value
---                 -----
refresh_interval    168h
hello               world

$ vault write my-secret1/hello foo=bar hello=world
Success! Data written to: my-secret1/hello

$ vault read my-secret1/hello
Key                 Value
---                 -----
refresh_interval    168h
foo                 bar
hello               world
</code></pre>
<p>그 다음은 <code>version 2</code></p>
<pre><code class="language-shell">$ vault kv put my-secret2/hello bar=foo
Key              Value
---              -----
created_time     2019-09-17T14:10:37.317296459Z
deletion_time    n/a
destroyed        false
version          1

# Version 1 과 달리 version 정보가 포함된 metadata 가 보인다

$ vault kv get my-secret2/hello
====== Metadata ======
Key              Value
---              -----
created_time     2019-09-17T14:10:37.317296459Z
deletion_time    n/a
destroyed        false
version          1

=== Data ===
Key    Value
---    -----
bar    foo

$ vault kv put my-secret2/hello world=hello bar=foo
Key              Value
---              -----
created_time     2019-09-17T14:13:25.68859452Z
deletion_time    n/a
destroyed        false
version          2

# version 정보가 2로 올라간다.

$ vault kv get my-secret2/hello
====== Metadata ======
Key              Value
---              -----
created_time     2019-09-17T14:13:25.68859452Z
deletion_time    n/a
destroyed        false
version          2

==== Data ====
Key      Value
---      -----
bar      foo
world    hello

# version 을 명시하여 가져올 수 도 있다.

$ vault kv get -version=1 my-secret2/hello
====== Metadata ======
Key              Value
---              -----
created_time     2019-09-17T14:10:37.317296459Z
deletion_time    n/a
destroyed        false
version          1

=== Data ===
Key    Value
---    -----
bar    foo

</code></pre>
<h4 id="secret-engine_2"><a class="toclink" href="../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#secret-engine_2">secret engine 비활성화</a></h4>
<pre><code class="language-shell">$ vault secrets enable -version=1 -path=temp kv
Success! Enabled the kv secrets engine at: temp/

$ vault secrets disable temp
Success! Disabled the secrets engine (if it existed) at: temp/
</code></pre>
<h3 id="token"><a class="toclink" href="../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#token">TOKEN 을 사용해보자</a></h3>
<h4 id="hcl"><a class="toclink" href="../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#hcl">정책 파일 .hcl 작성</a></h4>
<blockquote>
<p><code>.hcl</code> 확장자는 <code>Hashicorp Configuration Language</code> 를 의미함</p>
</blockquote>
<p><code>Version 1</code> 과 <code>Version 2</code> 에 대한 다른 정책을 기반으로 다른 두 토큰을 만들 예정이므로, <code>Version 1</code> 인 <code>my-secret1/*</code> 에 접근할 <code>my-policy1.hcl</code> 와 <code>Version 2</code> 인 <code>my-secret2/*</code> 에 접근할 <code>my-policy2.hcl</code> 을 만든다.</p>
<blockquote>
<p>my-policy1.hcl</p>
</blockquote>
<pre><code>path &quot;my-secret1/*&quot; {
  capabilities = [&quot;create&quot;, &quot;read&quot;, &quot;update&quot;, &quot;delete&quot;, &quot;list&quot;]
}
</code></pre>
<blockquote>
<p>my-policy2.hcl</p>
</blockquote>
<pre><code>path &quot;my-secret2/*&quot; {
  capabilities = [&quot;create&quot;, &quot;read&quot;, &quot;update&quot;, &quot;delete&quot;, &quot;list&quot;]
}
</code></pre>
<h4 id="_8"><a class="toclink" href="../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#_8">정책파일을 업로드 한다.</a></h4>
<p>업로드 하기 전 정합성 체크를 한다.</p>
<pre><code class="language-shell">$ vault policy fmt my-policy1.hcl
Success! Formatted policy: my-policy1.hcl

$ vault policy fmt my-policy2.hcl
Success! Formatted policy: my-policy2.hcl
</code></pre>
<p>정합성이 확인된 파일로 <code>my-policy</code> 란 이름으로 정책을 만든다.</p>
<pre><code class="language-shell">$ vault policy write my-policy1 ./my-policy1.hcl
Success! Uploaded policy: my-policy1

$ vault policy write my-policy2 my-policy2.hcl
Success! Uploaded policy: my-policy2
</code></pre>
<p>만들어진 정책을 확인해본다.</p>
<pre><code class="language-shell">$ vault policy list
default
my-policy1
my-policy2
root

$ vault policy read my-policy1
path &quot;my-secret1/*&quot; {
  capabilities = [&quot;create&quot;, &quot;read&quot;, &quot;update&quot;, &quot;delete&quot;, &quot;list&quot;]
}

</code></pre>
<h4 id="_9"><a class="toclink" href="../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#_9">만든 정책으로 토큰을 발급해본다</a></h4>
<pre><code class="language-shell">$ vault token create -policy=my-policy1
Key                  Value
---                  -----
token                s.Jb0UpJBV0bdtWYO8TxlDwphk
token_accessor       V8cFQMqcGSJihrFDbIzkBBqG
token_duration       168h
token_renewable      true
token_policies       [&quot;default&quot; &quot;my-policy1&quot;]
identity_policies    []
policies             [&quot;default&quot; &quot;my-policy1&quot;]

$ vault token create -policy=my-policy2
Key                  Value
---                  -----
token                s.BnRO5kDRZTAHHRMvZIk8qwia
token_accessor       90iSQdmmxhYSFaVq0CX4uSKb
token_duration       168h
token_renewable      true
token_policies       [&quot;default&quot; &quot;my-policy2&quot;]
identity_policies    []
policies             [&quot;default&quot; &quot;my-policy2&quot;]
</code></pre>
<h4 id="_10"><a class="toclink" href="../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#_10">발급한 토큰을 사용해보자</a></h4>
<ol>
<li>토큰 로그인</li>
<li>정책상의 경로로 <code>write</code>, <code>kv put</code></li>
<li>정책상의 경로로 <code>read</code>, <code>kv get</code></li>
<li>정책에 없는 경로로 <code>read</code>, <code>kv get</code></li>
</ol>
<p><code>Version 1</code> 부터 해본다.</p>
<pre><code class="language-shell"># 로그인
$ vault login s.Jb0UpJBV0bdtWYO8TxlDwphk
Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run &quot;vault login&quot;
again. Future Vault requests will automatically use this token.

Key                  Value
---                  -----
token                s.Jb0UpJBV0bdtWYO8TxlDwphk
token_accessor       V8cFQMqcGSJihrFDbIzkBBqG
token_duration       167h52m53s
token_renewable      true
token_policies       [&quot;default&quot; &quot;my-policy1&quot;]
identity_policies    []
policies             [&quot;default&quot; &quot;my-policy1&quot;]

# version 1 에선 read/write 명령어가 된다
$ vault write my-secret1/hello world=1
Success! Data written to: my-secret1/hello

# 데이터 확인
$ vault read my-secret1/hello
Key                 Value
---                 -----
refresh_interval    168h
world               1

# version 1 에선 kv get/put 도 된다.
$ vault kv put my-secret1/hello world=2 foo=bar
Success! Data written to: my-secret1/hello

# 데이터 확인
$ vault kv get my-secret1/hello
==== Data ====
Key      Value
---      -----
foo      bar
world    2

# 정책상에 없는 경로 접근
$ vault read my-secret2/hello
Error reading my-secret2/hello: Error making API request.

URL: GET http://127.0.0.1:8200/v1/my-secret2/hello
Code: 403. Errors:

* 1 error occurred:
        * permission denied
</code></pre>
<p>이번엔 <code>Version 2</code></p>
<pre><code class="language-shell"># 로그인
$ vault login s.BnRO5kDRZTAHHRMvZIk8qwia
Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run &quot;vault login&quot;
again. Future Vault requests will automatically use this token.

Key                  Value
---                  -----
token                s.BnRO5kDRZTAHHRMvZIk8qwia
token_accessor       90iSQdmmxhYSFaVq0CX4uSKb
token_duration       167h50m9s
token_renewable      true
token_policies       [&quot;default&quot; &quot;my-policy2&quot;]
identity_policies    []
policies             [&quot;default&quot; &quot;my-policy2&quot;]

# version 2 에선 read/write 명령을 사용할 수 없다.
$ vault write my-secret2/hello world=1
Error writing data to my-secret2/hello: Error making API request.

URL: PUT http://127.0.0.1:8200/v1/my-secret2/hello
Code: 404. Errors:


WARNING! The following warnings were returned from Vault:

  * Invalid path for a versioned K/V secrets engine. See the API docs for the
  appropriate API endpoints to use. If using the Vault CLI, use 'vault kv put'
  for this operation.

# 마찬가지
$ vault read my-secret2/hello
WARNING! The following warnings were returned from Vault:

  * Invalid path for a versioned K/V secrets engine. See the API docs for the
  appropriate API endpoints to use. If using the Vault CLI, use 'vault kv get'
  for this operation.

# 버전이 보인다. 이전에 몇번 데이터를 넣어서 버전이 3 이다.
$ vault kv put my-secret2/hello world=1
Key              Value
---              -----
created_time     2019-09-18T08:38:14.993018446Z
deletion_time    n/a
destroyed        false
version          3

# 데이터 확인
$ vault kv get my-secret2/hello
====== Metadata ======
Key              Value
---              -----
created_time     2019-09-18T08:38:14.993018446Z
deletion_time    n/a
destroyed        false
version          3

==== Data ====
Key      Value
---      -----
world    1

# 정책에 없는 경로로 접근
$ vault kv get my-secret1/hello
Error making API request.

URL: GET http://127.0.0.1:8200/v1/sys/internal/ui/mounts/my-secret1/hello
Code: 403. Errors:

* preflight capability check returned 403, please ensure client's policies grant access to path &quot;my-secret1/hello/&quot;
</code></pre>
<blockquote>
<p>K/V Version 2 에선 secret engine 뒤에 data 가 붙는다고 한다. Version 1 에선 필요 없지만 Version 2 에선 data 를 붙여줘야 한다.</p>
</blockquote>
<h4 id="_11"><a class="toclink" href="../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#_11">발급 토큰 삭제</a></h4>
<pre><code class="language-shell"># 둘다 없애고
$ vault token revoke s.Jb0UpJBV0bdtWYO8TxlDwphk
Success! Revoked token (if it existed)

$ vault token revoke s.BnRO5kDRZTAHHRMvZIk8qwia
Success! Revoked token (if it existed)

# 로그인하려면 실패한다.
$ vault login s.BnRO5kDRZTAHHRMvZIk8qwia
Error authenticating: error looking up token: Error making API request.

URL: GET http://127.0.0.1:8200/v1/auth/token/lookup-self
Code: 403. Errors:

* permission denied
</code></pre>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-08-27 00:00:00+00:00">August 27, 2019</time></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="redis"><a class="toclink" href="../../2019/08/27/redis-%EA%B8%B0%EC%B4%88/">Redis 기초</a></h2>
<blockquote>
<p><a href="https://bstar36.tistory.com/349">Redis 설정</a> 이 참 많다...</p>
<p>gcp 에서 docker 로 올린 redis 를 host 에서 설치한 redis-cli 로 공부를 해보자.
key-value 쌍으로 메모리에 저장되는 빠른 디비... 정도로 이해하고 있는데..</p>
</blockquote>
<h3 id="common-command"><a class="toclink" href="../../2019/08/27/redis-%EA%B8%B0%EC%B4%88/#common-command">Common Command</a></h3>
<h4 id="_1"><a class="toclink" href="../../2019/08/27/redis-%EA%B8%B0%EC%B4%88/#_1">모든키 검색</a></h4>
<pre><code class="language-shell">127.0.0.1:6379&gt; KEYS *
1) &quot;user:herdin&quot;
2) &quot;hset&quot;
3) &quot;hlist&quot;
4) &quot;redisTest1&quot;
5) &quot;counter&quot;
6) &quot;hello&quot;
</code></pre>
<h4 id="requirepass"><a class="toclink" href="../../2019/08/27/redis-%EA%B8%B0%EC%B4%88/#requirepass">권한획득(requirepass 옵션 사용 시)</a></h4>
<pre><code class="language-shell">127.0.0.1:6379&gt; KEYS *
(error) NOAUTH Authentication required.
127.0.0.1:6379&gt; AUTH &lt;YOUR PASSWORD&gt;
OK
</code></pre>
<h3 id="data-type"><a class="toclink" href="../../2019/08/27/redis-%EA%B8%B0%EC%B4%88/#data-type">Data Type</a></h3>
<p><a href="https://redis.io/topics/data-types">Redis Data Type</a></p>
<ul>
<li>Strings</li>
<li>Lists</li>
<li>Sets</li>
<li>Hashes</li>
<li>Sorted Sets</li>
<li>Bitmaps and HyperLogLogs</li>
</ul>
<h4 id="strings"><a class="toclink" href="../../2019/08/27/redis-%EA%B8%B0%EC%B4%88/#strings">Strings</a></h4>
<p><a href="https://redis.io/commands/#string">String Function</a></p>
<blockquote>
<p>binary safe 하다는 뜻이 뭘까? 최대 512M
INCR, DECR, INCRBY
APPEND
GETRANGE, SETRANGE.</p>
</blockquote>
<pre><code class="language-shell">127.0.0.1:6379&gt; SET hello redis01234
OK
127.0.0.1:6379&gt; SET hello
&quot;redis01234&quot;

#INCR INCRBY DECR DECRBY
127.0.0.1:6379&gt; SET counter 1000
OK
127.0.0.1:6379&gt; INCR counter
(integer) 1001
127.0.0.1:6379&gt; INCRBY counter 50
(integer) 1051
127.0.0.1:6379&gt; DECR counter
(integer) 1050
127.0.0.1:6379&gt; DECRBY counter 10
(integer) 1040

#GETRANGE SETRANGE
127.0.0.1:6379&gt; GETRANGE hello 0 2
&quot;red&quot;
127.0.0.1:6379&gt; GETRANGE hello 0 3
&quot;redi&quot;
127.0.0.1:6379&gt; GETRANGE hello 1 2
&quot;ed&quot;
127.0.0.1:6379&gt; SETRANGE hello 2 !!
(integer) 10
127.0.0.1:6379&gt; GET hello
&quot;re!!s01234&quot;

#GETBIT SETBIT
127.0.0.1:6379&gt; GET hello
&quot;re!!s01234&quot;
127.0.0.1:6379&gt; GETBIT hello 0
(integer) 0
127.0.0.1:6379&gt; GETBIT hello 1
(integer) 1
127.0.0.1:6379&gt; GETBIT hello 5
(integer) 0
127.0.0.1:6379&gt; GETBIT hello 4
(integer) 0
127.0.0.1:6379&gt; SETBIT hello 0 1
(integer) 0
127.0.0.1:6379&gt; GET hello
&quot;\xf2e!!s01234&quot;
127.0.0.1:6379&gt; SETBIT hello 0 0
(integer) 1
127.0.0.1:6379&gt; GET hello
&quot;re!!s01234&quot;
</code></pre>
<h4 id="lists"><a class="toclink" href="../../2019/08/27/redis-%EA%B8%B0%EC%B4%88/#lists">Lists</a></h4>
<blockquote>
<p>Lists 의 최대 길이는 2^32 - 1
LPUSH, LPOP, RPUSH, RPOP
LRANGE
LTRIM</p>
</blockquote>
<p><a href="https://redis.io/commands#list">List Function</a></p>
<pre><code class="language-shell">#LPUSH LPOP RPUSH RPOP
127.0.0.1:6379&gt; LPUSH hlist a
(integer) 1
127.0.0.1:6379&gt; LPUSH hlist b
(integer) 2
127.0.0.1:6379&gt; LPUSH hlist c
(integer) 3
127.0.0.1:6379&gt; RPOP hlist
&quot;a&quot;
127.0.0.1:6379&gt; LPOP hlist
&quot;c&quot;
127.0.0.1:6379&gt; LPOP hlist
&quot;b&quot;
127.0.0.1:6379&gt; LPOP hlist
(nil)

#LRANGE
127.0.0.1:6379&gt; LPUSH hlist a b c d e
(integer) 5
127.0.0.1:6379&gt; LRANGE hlist 0 1
1) &quot;e&quot;
2) &quot;d&quot;
127.0.0.1:6379&gt; LRANGE hlist 1 1
1) &quot;d&quot;
127.0.0.1:6379&gt; LRANGE hlist 0 0
1) &quot;e&quot;
127.0.0.1:6379&gt; LRANGE hlist 0 1
1) &quot;e&quot;
2) &quot;d&quot;
127.0.0.1:6379&gt; LRANGE hlist 0 100
1) &quot;e&quot;
2) &quot;d&quot;
3) &quot;c&quot;
4) &quot;b&quot;
5) &quot;a&quot;
127.0.0.1:6379&gt; LTRIM hlist 0 1
OK
127.0.0.1:6379&gt; LRANGE hlist 0 100
1) &quot;e&quot;
2) &quot;d&quot;
</code></pre>
<h4 id="sets"><a class="toclink" href="../../2019/08/27/redis-%EA%B8%B0%EC%B4%88/#sets">Sets</a></h4>
<p>순서가 없는 Strings 모음. 최대크기 2^32-1
추가, 삭제, O(1) 시간에 조회
아래에 Command reference 를 링크할 거라 커맨드는 생략</p>
<p><a href="https://redis.io/commands#set">Sets Function</a></p>
<pre><code class="language-shell">#SADD SREM SPOP SRANDMEMBER SCARD SMEMBERS SISMEMBER
127.0.0.1:6379&gt; SADD hset one #add member &quot;one&quot; to hset
(integer) 1
127.0.0.1:6379&gt; SADD hset two #add member &quot;two&quot; to hset
(integer) 1
127.0.0.1:6379&gt; SADD hset three #add member &quot;three&quot; to hset
(integer) 1
127.0.0.1:6379&gt; SADD hset four #add member &quot;four&quot; to hset
(integer) 1
127.0.0.1:6379&gt; SMEMBERS hset #return all member from hset
1) &quot;one&quot;
2) &quot;four&quot;
3) &quot;three&quot;
4) &quot;two&quot;

127.0.0.1:6379&gt; SPOP hset #remove and return random member from hset
&quot;three&quot;
127.0.0.1:6379&gt; SPOP hset 2 #remove and return random 2 members from hset
1) &quot;two&quot;
2) &quot;one&quot;
127.0.0.1:6379&gt; SMEMBERS hset #return all member from hset
1) &quot;four&quot;

127.0.0.1:6379&gt; SADD hset five #add member &quot;five&quot; to hset
(integer) 1
127.0.0.1:6379&gt; SADD hset six #add member &quot;six&quot; to hset
(integer) 1
127.0.0.1:6379&gt; SRANDMEMBER hset 3 #just return random 3 members from hset
1) &quot;five&quot;
2) &quot;six&quot;
3) &quot;four&quot;
127.0.0.1:6379&gt; SMEMBERS hset #return all member from hset
1) &quot;six&quot;
2) &quot;five&quot;
3) &quot;four&quot;
127.0.0.1:6379&gt; SCARD hset #return member count from hset
(integer) 3

127.0.0.1:6379&gt; SREM hset six #remove specific member from hset
(integer) 1

127.0.0.1:6379&gt; SMEMBERS hset #return all member from hset
1) &quot;five&quot;
2) &quot;four&quot;
127.0.0.1:6379&gt; SISMEMBER hset six #check specific member from hset
(integer) 0
</code></pre>
<h4 id="hashes-sorted-sets"><a class="toclink" href="../../2019/08/27/redis-%EA%B8%B0%EC%B4%88/#hashes-sorted-sets">Hashes, Sorted Sets 생략..</a></h4>
<p>참고
- <a href="https://www.zdnet.co.kr/view/?no=20131119174125">레디스 이렇게 쓰지 말자</a></p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-08-27 00:00:00+00:00">August 27, 2019</time></li>
        
        
          
          <li class="md-meta__item">
            
              1 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="selinux"><a class="toclink" href="../../2019/08/27/selinux-%EA%B0%80-%EB%AD%90%EC%A7%80/">SELinux 가 뭐지</a></h2>
<h3 id="selinux_1"><a class="toclink" href="../../2019/08/27/selinux-%EA%B0%80-%EB%AD%90%EC%A7%80/#selinux_1">SELinux 란..</a></h3>
<p><a href="https://www.lesstif.com/pages/viewpage.action?pageId=18219476#SELinux사용하기-SELinux아키텍처">일단 참고한 링크..</a></p>
<blockquote>
<p>SELinux 는 리눅스 커널의 일부이며 다음과 같은 아키텍처를 갖고 있다. 시스템 콜은 SELinux 보안 모듈을 통해 보안 정책을 질의한 후에 처리되며 모든 시스템 콜에 대해 SELinux가 보안 정책을 확인해서 접근 허용 여부를 판단 해야 하므로 속도를 빠르게 하기 위해 캐슁하여 처리하고 있으며 이 부분을 AVC(Access Vector Cache) 라고 부른다.</p>
</blockquote>
<p><code>SELinux</code> 는 아래의 세 가지 모드로 동작한다.</p>
<table class="pure-table">
  <thead>
    <tr>
      <td>mode name</td>
      <td>mode behavior</td>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>enforce</td>
      <td>정책과 룰에 어긋나는 동작은 모두 차단</td>
    </tr>
    <tr>
      <td>permissive</td>
      <td>정책과 룰에 어긋나는 동작이 있을 경우, 감사 로그(audit log)를 남기고 해당 작업은 허용</td>
    </tr>
    <tr>
      <td>disable</td>
      <td>SELinux 사용하지 않음.</td>
    </tr>
  </tbody>
</table>

<p><code>Security Context</code> 는 사용자, 역할, 타입, 레벨 로 이루어져있다.
<code>ls</code> , <code>ps</code> 에 <code>-Z</code> 옵션을 주면 해당 객체의 <code>Security Context</code> 를 알 수 있다.
기본적인 접근통제는 <code>Type Enforcement</code> 가 수행하며, 해당 로그는 <code>/var/log/audit/audit.log</code> 에 남게된다.</p>
<h4 id="sestatus-selinux-status"><a class="toclink" href="../../2019/08/27/selinux-%EA%B0%80-%EB%AD%90%EC%A7%80/#sestatus-selinux-status">sestatus (SELinux status)</a></h4>
<p>SELinux 의 상태를 체크한다.</p>
<pre><code class="language-shell">[herdin86@instance-20190319-second ~]$ sestatus
SELinux status:                 enabled
SELinuxfs mount:                /sys/fs/selinux
SELinux root directory:         /etc/selinux
Loaded policy name:             targeted
Current mode:                   enforcing
Mode from config file:          enforcing
Policy MLS status:              enabled
Policy deny_unknown status:     allowed
Max kernel policy version:      31
</code></pre>
<h4 id="getenforce"><a class="toclink" href="../../2019/08/27/selinux-%EA%B0%80-%EB%AD%90%EC%A7%80/#getenforce">getenforce</a></h4>
<p>현재 <code>SELinux</code> 의 모드를 확인한다.</p>
<pre><code class="language-shell">[herdin86@instance-20190319-second ~]$ getenforce
Enforcing
</code></pre>
<h4 id="setenforce"><a class="toclink" href="../../2019/08/27/selinux-%EA%B0%80-%EB%AD%90%EC%A7%80/#setenforce">setenforce</a></h4>
<p>현재 <code>SELinux</code> 의 모드를 변경한다. 별다른 응답을 주진 않는다.</p>
<pre><code class="language-shell">[herdin86@instance-20190319-second ~]$ setenforce --help
usage:  setenforce [ Enforcing | Permissive | 1 | 0 ]

[root@instance-20190319-second ~]# setenforce 0
[root@instance-20190319-second ~]# getenforce
Permissive
</code></pre>
<p>이 명령어로 모드를 변경한다해도 재부팅하면 설정이 초기화 된다.
영구설정은 <code>/etc/sysconfig/selinux</code> 을 열어서 <code>SELINUX=enforcing</code> 을 수정해 주면 된다.
해제 후 다시 설정할때 부팅시간이 길어진다고 한다.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-08-21 00:00:00+00:00">August 21, 2019</time></li>
        
        
          
          <li class="md-meta__item">
            
              1 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="_1"><a class="toclink" href="../../2019/08/21/%EC%95%94%ED%98%B8%ED%99%94-%EB%8C%80%EC%B9%AD%ED%82%A4%EC%99%80-%EA%B3%B5%EA%B0%9C%ED%82%A4/">암호화, 대칭키와 공개키</a></h2>
<h4 id="_2"><a class="toclink" href="../../2019/08/21/%EC%95%94%ED%98%B8%ED%99%94-%EB%8C%80%EC%B9%AD%ED%82%A4%EC%99%80-%EA%B3%B5%EA%B0%9C%ED%82%A4/#_2">대칭키</a></h4>
<p>암/복호화하는 키가 같은 방식을 말한다. 대표적으로 <code>OTP</code>, <code>AES</code>, <code>DES</code> 가 있다.</p>
<blockquote>
<p><code>OPT</code> One Time Password 는 흔히 사용하니까 그렇다치더라도, <code>AES</code> 와 <code>DES</code> 두개가 뭐가 다른지는 모른다.</p>
</blockquote>
<p>송신측에서 가진 암호화키와 수신측에서 가진 복호화키가 같은 경우이다.<br />
- 송/수신 측에서 암복호화를 해야하기 때문에 같은 키를 공유해야하고 -&gt; 공유 중 유출 가능성이 올라간다.
- 두군데서 같은 키를 관리하므로 관리포인트가 늘어난다 -&gt; 역시 유출가능성이 올라간다.</p>
<h4 id="_3"><a class="toclink" href="../../2019/08/21/%EC%95%94%ED%98%B8%ED%99%94-%EB%8C%80%EC%B9%AD%ED%82%A4%EC%99%80-%EA%B3%B5%EA%B0%9C%ED%82%A4/#_3">공개키</a></h4>
<p>송신측과 수신측에서 사용하는 암/복호화 키가 다른 경우를 말한다. 대표적으로 <code>RSA</code>, <code>DSA</code> 가 있다.</p>
<p>암호화 한 키로는 복호화할 수가 없다.<br />
그 말은, 공개키로 암호화한 정보를 공개키로 다시 복호화할 순 없지만, 개인키로는 복호화 할 수 있다.<br />
마찬가지로 개인키로 암호화한 정보는 개인키로 다시 복호화할 순 없지만, 공개키로 복호화할 수 있다.</p>
<p>수신측에서 미리 송신측에 공개키를 전달하고, 전달된 공개키로 암호화한 정보를 송신측에서 수신측으로 보낸다.<br />
그럼 수신측에서 갖고있는 개인키로 복호화를 한다.</p>
<blockquote>
<p>좀 더 자세하게 공부하고 싶은데 분명 다른거하다가 안할 듯해서 포스트를 마친다..</p>
</blockquote>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-08-21 00:00:00+00:00">August 21, 2019</time></li>
        
        
          
          <li class="md-meta__item">
            
              6 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="oauth"><a class="toclink" href="../../2019/08/21/oauth/">OAuth</a></h2>
<p><code>OAuth</code> 를 알아보기 전에 용어 정리가 필요하다.
- Authentication : 인증, <code>내맘대로 해석 - 요청 대상이 예상하는 대상이 맞는지 확인하는 것.</code></p>
<blockquote>
<p>컴퓨터 보안에서 인증은 로그인 요청 등을 통해 통신 상에서 보내는 사람의 디지털 정체성을 확인하는 시도의 과정이다. <a href="https://ko.wikipedia.org/wiki/%EC%9D%B8%EC%A6%9D#%EC%BB%B4%ED%93%A8%ED%84%B0_%EB%B3%B4%EC%95%88">출처</a></p>
</blockquote>
<ul>
<li>Authorization : 허가, 인가, <code>내맘대로 해석- 요청 자원에 대한 접근 허가</code><blockquote>
<p>허가(허용; authorization)란 리소스에 대한 접근 권한 및 정책을 지정하는 기능이다. 정보 보안 및 컴퓨터 보안, 특히 접근 제어 분야와 관련이 있다.[1] 예를 들어 인사부서 직원들은 보통 직원 데이터를 열람할 수 있도록 허용되어 있는데, 이러한 정책은 일반적으로 컴퓨터 시스템에 접근 제어 규칙들로 저장된다. 컴퓨터 시스템은 어떤 (인증된) 리소스 수요자가 리소스에 대한 요청을 하면, 저장된 접근 제어 규칙들을 적용해 요청을 허가할지 거부할지를 결정한다. 여기서 리소스는 개개의 파일 또는 데이터, 컴퓨터 프로그램이나 프로그램의 일부 기능, 컴퓨터 하드웨어 및 장치 등을 포함한다. 그리고 리소스 수요자는 컴퓨터 사용자뿐만 아니라 컴퓨터 프로그램이나 다른 장치들이 될 수도 있다. <a href="https://ko.wikipedia.org/wiki/허가_(컴퓨터_과학)">출처</a></p>
</blockquote>
</li>
</ul>
<p><a href="https://tools.ietf.org/html/rfc6749">Request for Comments: 6749, RFC 6749</a></p>
<h3 id="oauth-10a"><a class="toclink" href="../../2019/08/21/oauth/#oauth-10a"><code>OAuth 1.0a</code></a></h3>
<p>1.0 이 기존에 있었지만, 보안이 수정된 1.0 revision A 이 표준 <code>RFC5849</code> 로 등록이 되었다고하니 1.0 revision A 만 살짝 맛보고 가면 되겠다. 지금 사용하는건 대부분 2.0 이니까..</p>
<h4 id="_1"><a class="toclink" href="../../2019/08/21/oauth/#_1">용어</a></h4>
<table class="pure-table">
<thead>
  <tr>
    <th>용어</th>
    <th>설명</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td>User</td>
    <td>Service Provider 에 계정을 가지고 있으면서, Consumer 를 이용하려는 사용자</td>
  </tr>
  <tr>
    <td>Consumer</td>
    <td>OAuth 를 사용하는 Open API 를 제공하는 서비스</td>
  </tr>
  <tr>
    <td>Service Provider</td>
    <td>OAuth 인증을 사용해 Service Provider 의 기능을 사용하려는 애플리케이션이나 웹 서비스</td>
  </tr>
  <tr>
    <td>Request Token</td>
    <td>Consumer가 Service Provider 에게 접근 권한을 인증받기 위해 사용하는 값. 인증이 완료된 후에는 Access Token 으로 교환.</td>
  </tr>
  <tr>
    <td>Access Token</td>
    <td>인증 후 Consumer 가 Service Provider 의 자원에 접근하기 위한 키를 포함한 값</td>
  </tr>
</tbody>
</table>

<h4 id="flow"><a class="toclink" href="../../2019/08/21/oauth/#flow">Flow</a></h4>
<p><img alt="OAuth1.0 flow" src="/assets/images/posts/2019-08-21-oauth-02.png" /></p>
<p><code>OAuth 2.0</code> 을 먼저 배웠고, 어떤 형태를 거쳐 여기까지 왔는지 궁금하여 검색해 본 것인데, <code>Flow</code> 를 대충 보고 참고자료를 보며 느낀 점은 <code>음? 별로 크게 다르지 않은 것 같네?</code> 였다. 웹애플리케이션이 아닌 일반 애플리케이션에 대한 지원강화, HTTPS 사용으로 보안알고리즘 사용 자제, <code>Access Token</code> 의 만료적용. 이 정도가 크게 달라진 점 같다. 아 그냥 이랬구나 하고 넘어가련다.</p>
<h3 id="oauth-20"><a class="toclink" href="../../2019/08/21/oauth/#oauth-20"><code>OAuth 2.0</code></a></h3>
<h4 id="_2"><a class="toclink" href="../../2019/08/21/oauth/#_2">용어</a></h4>
<div id="pureTableHere"></div>
<script>
  util().genPureTable(
    'pureTableHere',
    ['용어', '설명'],
    [
      ['Client', 'OAuth 인증을 사용해 Resource Server 의 Resource Owner 의 Resource 를 획득하려는 애플리케이션이나 웹 서비스 (ex: Facebook 에 공유 기능을 제공하는 앱)'],
      ['Resource Owner', 'Resource 를 Resource Server 에 가지고 있으면서, Client 를 이용하려는 사용자 (ex: 일반사용자)'],
      ['Authoriztion Server', 'Authentication (인증) 이 끝난 뒤, 어떤 자원에 접근할지 Authorization (인가) 해 주는 서버'],
      ['Resource Server', 'Resource Owner 의 Resource 를 관리하는 서버'],
    ]
  );
</script>

<p>RFC 상에는 5가지 방식이 있다.
1. Authorization Code Grant - 아래에서 설명
2. Implicit Grant
  - 암시적 승인 - 보통 javascript 로 사용
  - user-agent(보통 브라우저) 에서 권한(Authorization)요청과 토큰요청이 분리되어 나감.<br />
  - client 의 인증(authentication) 이 없다.
  - access token 이 redirection URI 에 노출된다.
  - refresh token 이 없다.
3. Resource Owner Password Credentials Grant
  - resource owner(유저) 의 비밀번호를 app 에서 저장하는 방법
4. Client Credentials Grant
  - app(client) 의 자격만 가지고 토큰을 발급받는 방법
  - app 을 신뢰하기 때문에 다른 인증 필요 없이 바로 토큰을 발급해준다.
  - 보통은 Authorization Server 와 Client 가 같은 주체일 때 그런듯
5. Extension Grants
  - 이건 그냥 알아서 해라 같은데.. RFC 에도 딱히 뭐가 없네</p>
<h3 id="authorization-code-grant"><a class="toclink" href="../../2019/08/21/oauth/#authorization-code-grant">Authorization Code Grant</a></h3>
<p>개인적으로 가장 보편적이라 생각하는 <code>Authorization Code Grant</code> 방식에 대해서 설명한다.</p>
<p><img alt="OAuth2.0 Flow" src="/assets/images/posts/2019-08-21-oauth-01.png" /></p>
<blockquote>
<p><a href="https://api.slack.com/docs/oauth">from slack api doc</a></p>
</blockquote>
<p><code>Flow</code> 를 보면 알 수 도 있지만, 간략하게 순서를 정리해 보자면 (<code>Web Application</code> 기준)</p>
<ol>
<li><code>OAuth 2.0</code> 의 방식으로 <code>API Service</code> 를 제공하는 서비스에 가입하여 본인이 개발할 <code>Web Application</code> 을 등록한다.</li>
<li><code>Client ID</code>, <code>Client Secret</code> 을 발급 받고, 본인이 개발할 <code>Web Application</code> 의 <code>Callback URL</code> 을 등록한다.</li>
<li><code>Access Token</code> 을 <code>OAuth 2.0 Flow</code> 에 따라서 발급받는 <code>Web Application</code> 기능을 추가한다.</li>
<li><code>OAuth 2.0 Flow</code> 를 따라 <code>Web Application</code> 에서 <code>Acess Token</code> 을 발급 받는다.</li>
<li><code>Acess Token</code> 으로 <code>Resource</code> 에 접근한다.</li>
</ol>
<p>Naver, Facebook, Instagram, Google+ 등과 라이브러리 없이 연동을 해 보았다. 약간씩 파라미터가 다르지만 대동소이하다. 예제는 Naver.</p>
<h4 id="constants-class"><a class="toclink" href="../../2019/08/21/oauth/#constants-class">설정 값을 저장할 <code>Constants</code> class.</a></h4>
<pre><code class="language-java">package util;

import io.netty.handler.codec.http.HttpMethod;

public class Constants {
    public enum OAUTH2_CLIENT {
        NAVER(
            /* auth uri     */ &quot;https://nid.naver.com/oauth2.0/authorize&quot;
            /* auth method  */, HttpMethod.POST
            /* token uri    */, &quot;https://nid.naver.com/oauth2.0/token&quot;
            /* token method */, HttpMethod.POST
            /* resource uri           */, &quot;https://openapi.naver.com/v1/nid/me&quot;
            /* resource method        */, HttpMethod.POST
            /* resource header keys   */, new String[] {&quot;Authorization&quot;}
            /* resource header values */, new String[] {&quot;Bearer &quot;}
            /* client id     */, &quot;MY_CLIENT_ID&quot;
            /* client secret */, &quot;MY_CLIENT_SECRET&quot;
            /* callback uri  */, &quot;MY_CALLBACK_URL&quot;
        ),
        ;
        private String authUri;
        private HttpMethod authPreferedMethod;
        private String tokenUri;
        private HttpMethod tokenPreferedMethod;
        private String resourceServerUrl;
        private HttpMethod resourceServerPreferedMethod;
        private String[] resourceHeaderKey;
        private String[] resourceHeaderValue;
        private String clientId;
        private String clientSecret;
        private String callbackUri;
        public String getAuthUri() { return this.authUri; }
        public HttpMethod getAuthPreferedMethod() { return this.authPreferedMethod; }
        public String getTokenUri() { return this.tokenUri; }
        public HttpMethod getTokenPreferedMethod() { return this.tokenPreferedMethod; }
        public String getResourceServerUrl() { return this.resourceServerUrl; }
        public HttpMethod getResourceServerPreferedMethod() { return this.resourceServerPreferedMethod; }
        public String[] getResourceHeaderKeys() { return this.resourceHeaderKey; }
        public String[] getResourceHeaderValues() { return this.resourceHeaderValue; }
        public String getClientId() {return this.clientId; }
        public String getClientSecret() { return this.clientSecret; }
        public String getCallbackUri() { return this.callbackUri; }
        @Override
        public String toString() { return &quot;DO NOT USE DEFAULT TOSTRING&quot;; }
        private OAUTH2_CLIENT(
                String authUri
                , HttpMethod authPreferedMethod
                , String tokenUri
                , HttpMethod tokenPreferedMethod
                , String resourceServerUrl
                , HttpMethod resourceServerPreferedMethod
                , String[] resourceHeaderKey
                , String[] resourceHeaderValue
                , String clientId
                , String clientSecret
                , String callbackUri
        ) {
            this.authUri = authUri;
            this.authPreferedMethod = authPreferedMethod;

            this.tokenUri = tokenUri;
            this.tokenPreferedMethod = tokenPreferedMethod;

            this.resourceServerUrl = resourceServerUrl;
            this.resourceServerPreferedMethod = resourceServerPreferedMethod;
            this.resourceHeaderKey = resourceHeaderKey;
            this.resourceHeaderValue = resourceHeaderValue;

            this.clientId = clientId;
            this.clientSecret = clientSecret;
            this.callbackUri = callbackUri;
        }
    }//END OF ENUM
}//END OF CLASS
</code></pre>
<h4 id="access-token-testauthfacebookcontroller-class"><a class="toclink" href="../../2019/08/21/oauth/#access-token-testauthfacebookcontroller-class">인증과 인가를 거쳐 <code>Access Token</code> 발급을 위한 <code>TestAuthFacebookController</code> class</a></h4>
<pre><code class="language-java">package controller;

import java.io.UnsupportedEncodingException;
import java.math.BigInteger;
import java.net.URLEncoder;
import java.nio.charset.Charset;
import java.security.SecureRandom;
import java.util.Map;

import javax.servlet.http.HttpServletResponse;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.ModelAndView;

import com.fasterxml.jackson.databind.ObjectMapper;

import util.Constants.OAUTH2_CLIENT;
import util.HttpUtils;

@Controller
public class TestAuthFacebookController {

    private static final Logger logger = LoggerFactory.getLogger(TestAuthFacebookController.class);
    public static String storedState = &quot;&quot;;

    @RequestMapping(value=&quot;oauth/facebook/init&quot;, method=RequestMethod.GET)
    public ModelAndView oAuth2TestFacebookInit(HttpServletResponse httpServletResponse) throws UnsupportedEncodingException {
        String stateToken = new BigInteger(130, new SecureRandom()).toString(32);
        logger.debug(&quot;stateToken : &quot; + stateToken);
        TestAuthFacebookController.storedState = stateToken;
        String redirectUrl = OAUTH2_CLIENT.FACEBOOK.getAuthUri()
                + &quot;?client_id=&quot; + OAUTH2_CLIENT.FACEBOOK.getClientId()
                + &quot;&amp;response_type=code&quot;
                + &quot;&amp;redirect_uri=&quot; + URLEncoder.encode(OAUTH2_CLIENT.FACEBOOK.getCallbackUri(), Charset.forName(&quot;UTF-8&quot;).toString())
                + &quot;&amp;state=&quot; + stateToken
                + &quot;&amp;scope=public_profile email manage_pages&quot;;
        return new ModelAndView(&quot;redirect:&quot; + redirectUrl);
    }//END OF FUNCTION

    @RequestMapping(value=&quot;oauth/facebook/callback&quot;, method=RequestMethod.GET)
    public String oAuth2TestFacebookCallback(@RequestParam Map&lt;String,Object&gt; map) throws Exception {
        String recvState = (String) map.get(&quot;state&quot;);
        logger.debug(&quot;recv state : &quot; + recvState);
        String recvCode = (String) map.get(&quot;code&quot;);
        logger.debug(&quot;oAuth2TestFacebookCallback recv code : &quot; + recvCode);
        if(TestAuthFacebookController.storedState.equals(recvState)) {
            String paramStr = &quot;&quot;
                + &quot;client_id=&quot; + OAUTH2_CLIENT.FACEBOOK.getClientId()
                + &quot;&amp;client_secret=&quot; + OAUTH2_CLIENT.FACEBOOK.getClientSecret()
                + &quot;&amp;code=&quot; + recvCode
                + &quot;&amp;redirect_uri=&quot; + OAUTH2_CLIENT.FACEBOOK.getCallbackUri();

            ObjectMapper mapper = new ObjectMapper();
            String jsonInString = HttpUtils.sendAndRecv(
                OAUTH2_CLIENT.FACEBOOK.getTokenUri()
                , OAUTH2_CLIENT.FACEBOOK.getTokenPreferedMethod()
                , paramStr
            );

            logger.debug(&quot;AuthorizationServer recv : &quot; + jsonInString);

        } else {
            throw new Exception(&quot;&quot;);
            //401 unauthorized
        }
        return &quot;main&quot;;
    }//END OF FUNCTION

}//END OF CLASS

</code></pre>
<p>참고
- <a href="https://d2.naver.com/helloworld/24942">Naver - OAuth와 춤을</a></p>
<h3 id="facebook-api-"><a class="toclink" href="../../2019/08/21/oauth/#facebook-api-">Facebook API - 로그인 플로 직접 빌드</a></h3>
<p><a href="https://developers.facebook.com/docs/facebook-login/manually-build-a-login-flow#token">공식문서</a></p>
<h4 id="url"><a class="toclink" href="../../2019/08/21/oauth/#url">로그인 대화 상자 호출 및 리디렉션 URL 설정</a></h4>
<p>클라이언트 앱(서버)에서 페이스북 로그인 화면으로 리디렉션 한다.<br />
로그인 화면에서 사용자(Resource Owner)가 응답을 했을 경우, 되돌아올 클라이언트 앱의 리디렉션 URL (페이스북 앱 관리 페이지에서 미리 설정된 URL 과 같아야함) 과 CSRF 를 위한 문자열 <code>state</code> 을 설정해 준다.</p>
<pre><code>https://www.facebook.com/v4.0/dialog/oauth?
  client_id={app-id}
  &amp;redirect_uri={redirect-uri}
  &amp;state={state-param}
</code></pre>
<ul>
<li><code>client_id</code> : 페이스북 앱 관리 페이지에서 등록한 클라이언트 앱의 발급받은 ID</li>
<li><code>redirect_uri</code> : 사용자가 로그인 후, 권한승인을 했을 때 리디렉션될 클라이언트 앱의 URI</li>
<li><code>state</code> : 아래 네 단계의 flow 를 거치면서 위변조를 막기위해 클라이언트 앱이 1 단계에서 만들어서 4. 단계에서 돌려 받는 문자열.</li>
<li>클라이언트 앱</li>
<li>사용자 로그인</li>
<li>권한서버</li>
<li>클라이언트 앱</li>
<li><code>response_type</code> : 클라이언트 앱으로 리디렉션할 때 포함된 응답 데이터가 URL 매개변수인지 아니면 프래그먼트인지 결정하는 옵션</li>
<li><code>code</code> : 응답 데이터는 URL 매개변수, 기본값</li>
<li>... 뭐가 더 있음. 하지만 관심이 없으므로 생략.</li>
</ul>
<p>그럼 사용자는 페이스북 로그인 화면을 보게되고, 로그인 후 해당 클라이언트 앱에서 사용할 수 있는 권한을 선택한 뒤, 승인 여부를 선택한다. 그러면 기존에 설정된 클라이언트 앱의 리디렉션 URL 을 호출해 준다.</p>
<h4 id="_3"><a class="toclink" href="../../2019/08/21/oauth/#_3">로그인 대화 상자 응답 처리</a></h4>
<p>위에서 <code>response_type</code> 을 <code>code</code> 로 했기 때문에, <code>access token</code> 과 교환 할 수 있는 <code>code</code> 와 클라이언트 앱에서 생성한 <code>state</code> 를 돌려 받는다. <code>state</code> 가 생성했던 값과 같은지 확인 한 다음,  <code>code</code> 를 <code>access token</code> 으로 교환한다.</p>
<pre><code>GET https://graph.facebook.com/v4.0/oauth/access_token?
   client_id={app-id}
   &amp;redirect_uri={redirect-uri}
   &amp;client_secret={app-secret}
   &amp;code={code-parameter}
</code></pre>
<ul>
<li><code>client_id</code> : 페이스북 앱 관리 페이지에서 등록한 클라이언트 앱의 발급받은 ID</li>
<li><code>redirect_uri</code> : OAuth 로그인 프로세스를 시작할 때 사용한 원래 <code>request_uri</code></li>
<li><code>client_secret</code> : 페이스북 앱 관리 페이지에서 등록한 클라이언트 앱의 발급받은 Secret</li>
<li><code>code</code> : 전달 받은 <code>code</code></li>
</ul>
<p>위와 같이 요청을 하면, 아래와 같이 응답을 받을 수 있다.</p>
<pre><code class="language-json">{
  &quot;access_token&quot;: {access-token},
  &quot;token_type&quot;: {type},
  &quot;expires_in&quot;:  {seconds-til-expiration}
}
</code></pre>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-08-19 00:00:00+00:00">August 19, 2019</time></li>
        
        
          
          <li class="md-meta__item">
            
              6 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="https-tls-ssl"><a class="toclink" href="../../2019/08/19/https-tls-ssl-%EC%A0%84%EC%9E%90%EC%84%9C%EB%AA%85/">HTTPS, TLS, SSL, 전자서명</a></h2>
<blockquote>
<p>나는 그냥 HTTPS 만 알고싶은데 왜 하나만 알면 안되는거야 행복할수가업서...ㅠㅠ</p>
</blockquote>
<p><img src="#" post-src="2019-08-19-https-ssl-tls.jpg" /></p>
<h3 id="https-ssl-tls"><a class="toclink" href="../../2019/08/19/https-tls-ssl-%EC%A0%84%EC%9E%90%EC%84%9C%EB%AA%85/#https-ssl-tls">HTTPS 와 SSL, TLS 그게 다 뭐지?</a></h3>
<p>HTTP 는 <code>HyperText Transfer Protocol</code> 이다.  웹상에서 정보를 주고 받기 위한 프로토콜이다.<br />
HTTPS 는 <code>HyperText Transfer Protocol over Secure Socket Layer</code> 이다. 즉, SSL 위에서 동작하는 HTTP 인것이다.<br />
그럼 SSL 은 뭐냐. SSL 은 <code>Secure Socket Layer</code> 이다.<br />
그럼 TLS 는 또 뭐냐. TLS 는 <code>Transport Layer Security</code> 이다.</p>
<blockquote>
<p>넷스케이프 커뮤니케이션스사가 개발한 SSL(Secure Sockets Layer)에 기반한 기술로, 국제 인터넷 표준화 기구에서 표준으로 인정받은 프로토콜이다. 표준에 명시된 정식 명칭은 TLS지만 아직도 SSL이라는 용어가 많이 사용되고 있다. <a href="https://namu.wiki/w/TLS">출처</a></p>
</blockquote>
<p>SSL 기반으로 TLS 가 표준으로 명시되었지만(정확히는 <code>SSL 3.0</code> 기반으로 <code>TLS 1.0</code> 을 만듬), 그냥 SSL 이란 용어를 혼용해서 사용하고 있는 것 같다.</p>
<h4 id="tls"><a class="toclink" href="../../2019/08/19/https-tls-ssl-%EC%A0%84%EC%9E%90%EC%84%9C%EB%AA%85/#tls">TLS 의 순서</a></h4>
<blockquote>
<p>사전작업
1. 서버에서 private key, public key 를 만든다
2. 만들어진 public key 와 서버의 몇몇 정보를 CA 에 제출한다.
3. 서버의 public key 와 인증기관의 정보를 담아 인증서에 담고, 이 모든 정보를 hash 한 다음 CA 의 비밀키로 암호화 한 값을 추가한다. (전자서명)
4. CA 로부터 발급받은 인증서를 서버에 세팅한다.
1. <strong>클라이언트에서 서버에 ClientHello 메시지를 보낸다.</strong> 여기에는 클라이언트에서 가능한 TLS 버전, 서버 도메인, 세션 식별자, 암호 설정 등의 정보가 포함된다.
2. 클라이언트의 메시지를 받은 <strong>서버는 ServerHello 메시지를 클라이언트에게 보낸다.</strong> 여기에는 ClientHello 메시지의 정보 중 서버에서 사용하기로 선택한 TLS 버전, 세션 식별자, 암호 설정 등의 정보가 포함된다.
3. <strong>서버가 클라이언트에 Certificate 메시지를 보낸다.</strong> 여기에는 (사전작업에서 만든)서버의 인증서가 들어간다. 이 인증서는 별도의 인증 기관에서 발급받은 것이며, 서버가 신뢰할 수 있는 자임을 인증한다. 전송이 끝나면 ServerHelloDone 메시지를 보내 끝났음을 알린다.
4. <strong>클라이언트는 서버에서 받은 인증서를 검증한다.</strong> 인증서의 유효 기간이 만료되지 않았는지, 그 인증서가 해당 서버에게 발급된 인증서가 맞는지 등을 확인한다. 인증서를 신뢰할 수 있다고 판단하였다면 다음 단계로 넘어간다.
  보통 브라우저에는 유명한 CA 들의 공개키를 미리 가지고 있다.
  CA 의 공개키로 인증서의 전자서명 (암호화된 hash 값) 을 복호화하여 위변조되지 않았음을 확인한다.
  검증이후 인증서에 담겨있는 서버의 public key 를 획득한다.
5. <strong>클라이언트는</strong> 임의의 pre-master secret을 생성한 뒤, 서버가 보낸 인증서에 포함된 공개 키를 사용해 암호화한다. 이렇게 <strong>암호화된 pre-master secret을</strong> ClientKeyExchange 메시지에 포함시켜 <strong>서버에 전송한다.</strong>
6. <strong>서버는</strong> 전송받은 정보를 복호화하여 pre-master secret을 알아낸 뒤, 이 정보를 사용해 master secret을 생성한다. 그 뒤 master secret에서 <strong>세션 키를 생성</strong>해내며, 이 세션 키는 앞으로 서버와 클라이언트 간의 통신을 암호화하는데 사용할 것이다. 물론 <strong>클라이언트 역시</strong> 자신이 만들어낸 pre-master secret을 알고 있으므로, 같은 과정을 거쳐 <strong>세션 키를 스스로 만들 수 있다.</strong>
7. 이제 <strong>서버와 클라이언트는 각자 동일한 세션 키를 가지고 있으며, 이를 사용해 대칭 키 암호를 사용하는 통신을 할 수 있다.</strong> 따라서 우선 서로에게 ChangeCipherSpec 메시지를 보내 앞으로의 모든 통신 내용은 세션 키를 사용해 암호화해 보낼 것을 알려준 뒤, Finished 메시지를 보내 각자의 핸드셰이킹 과정이 끝났음을 알린다.
  이 과정에서 디피헬먼 알고리즘이 사용된다
8. 이제 서버와 클라이언트 간에 보안 통신이 구성된다. <a href="https://namu.wiki/w/TLS">출처</a></p>
<p>음 좀 더 자세히 알고 싶지만 가성비가 격하게 떨어질 것 같은 느낌..</p>
</blockquote>
<h3 id="_1"><a class="toclink" href="../../2019/08/19/https-tls-ssl-%EC%A0%84%EC%9E%90%EC%84%9C%EB%AA%85/#_1">전자서명이 뭐지?</a></h3>
<p>먼저 서명에 대한 정의.</p>
<blockquote>
<p>서명(署名, 문화어: 수표)은 누군가의 이름, 가명, 또는 누군가가 문서에 기록했다는 증거, 자기 동일성을 위한 표시로 손으로 쓴 것을 말한다. 사인(sign)이라고도 한다.<br />
(A가 B에게 어떤 문서 D를 건네 줬을때, D를 A가 기록한 뒤로 누군가 변조하지 않았다는 증거이다.)</p>
</blockquote>
<p>전자서명에 대해서 알아보기 전에, 어떤 데이터(B1)를 배포하는 과정을 생각해 보자.<br />
데이터를 배포할 때, 받는 쪽에서 데이터가 변조되지 않았음을 확인하기 위해 해싱을 사용한다.
데이터를 해싱하여 해시값(H1)을 얻고 이를 배포자의 암호화키(KeyE)로 암호화 하여 서명(S)이란 것을 만든다.
그리고 데이터(B1), 서명(S), 그리고 배포자의 복호화키(KeyD) 를 배포셋(C1)으로 만들어 배포한다.</p>
<p>배포하는 과정과 배포받은 사용자가 이를 검증하는 과정은 아래와 같다.</p>
<pre><code>//배포과정
Hash(B1) =&gt; H1;                 // 배포데이터(B1)을 해시 함수에 입력하여 해시값(H1)을 얻음  
Encrypt(KeyE, H1) =&gt; S;         // 해시값(H1)을 개인키(KeyE)로 암호화하여 서명(S)을 얻음  
C1 = {B1, S, KeyD}              // 배포데이터(B1), 서명(S), 공개키(KeyD)를 묶어서 배포셋(C1, 코드사인 바이너리) 생성

//배포검증과정
C1 =&gt; B1, S, KeyD;                            // 다운로드 한 배포셋(C1)을 배포데이터(B1), 서명(S), 공개키(KeyD)로 분리  
Decrypt(KeyD, S) =&gt; H1;                       // 서명(S)을 공개키(KeyD)로 복호화하여 해시값(H1)을 얻음  
Hash(B1) =&gt; H1';                              // 배포데이터(B1)을 해시 함수에 입력하여 해시값(H1')을 얻음  
If H1 == H1', Execute C1 =&gt; Very Good!        // 두 해시값이 일치하는 것을 확인
</code></pre>
<p>위의 과정에서 해커가 데이터(B1) 을 다른 데이터(B2) 로 바꿔서 <code>C1 =&gt; {B2, S, KeyD}</code> 로 배포하는 과정은 막을 수 있어도,</p>
<blockquote>
<p>배포받은 사용자가 KeyD 로 S 를 복호화 하면 H1' 를 구할 수 있고, B2 를 해싱하면 H1 이 나오기 때문에 복호화 하여 구한 H1' 과 직접 해싱한 H1 을 비교하면 변조유무를 확인할 수 있기 때문이다.</p>
</blockquote>
<p>B2 로 부터 새로운 해쉬 값과 새로운 비대칭키를 만들어 배포하는 과정은 검증할 수가 없다.</p>
<p>따라서. 공인인증기관이라는 제 3의 검증기관이 필요하다. 이때 사용하는 것이 인증서이다.</p>
<pre><code>INFO_LIST = {
  일련번호,
  ...,
  발급자(인증기관),
  주체(발급대상, 데이터를 배포하고자 하는 주체),
  주체의 공개키,
  ...,
  확장
}
Hash(INFO_LIST) =&gt; HASH1;   // 필요한 정보(INFO_LIST)들을 해시하여 해시값(HASH1)을 구한다.
Encrypt(CKeyE, HASH1) =&gt; CS // 인증기관의 개인키(CKeyE)로 해시값(HASH1)을 암호화 하여 인증기관의 서명(CS)을 구한다.
CT = { INFO_LIST, CS }      // 인증서(CT)는 필요한 정보(INFO_LIST)와 인증기관의 서명(CS)으로 구성된다.
</code></pre>
<p>그럼 인증기관을 포함한 배포과정을 다시 작성해 보자.</p>
<pre><code>C1 = { B1, CT : { INFO_LIST, CS }, S } // 배포셋(C1)은 배포데이터(B1)와 인증서(CT)와 배포자의 서명(S)로 구성되어 있다.
C1 =&gt; B1, CT : { INFO_LIST, CS }, S    // 배포받은 사용자는 배포셋(C1)을 분리한다.
CT =&gt; INFO_LIST, CS                    // 인증서(CT) 를 분리한다.
INFO_LIST =&gt; ..., KeyD, ...            // 필요한 정보(INFO_LIST)에서 배포자의 공개키(KeyD) 를 분리한다.
Decrypt(KeyD, S) =&gt; H1                 // 배포자의 공개키(KeyD) 로 배포자의 서명(S)를 복호화 하여 해시값(H1)을 구한다.
Hash(B1) =&gt; H1'                        // 배포데이터(B1)을 직접 해시하여 해시값(H1')을 구한다.
If H1 == H1', Checked                  // 복호화한 해시값(H1)과 직접 해시한 해시값(H1')이 같은지 비교한다. 여기까지는 이전의 인증과정과 별반 다르지 않다.

Check(INFO_LIST)                             // 필요한 정보(INFO_LIST)에서 배포자에 대한 정보를 확인한다.
Decrypt(CKeyD, CS) =&gt; HASH1                  // 인증기관의 공개키(CKeyD, 뜬금없이 나온 인증기관의 공개키는 이미 가지고 있다고 가정한다.)로 인증기관의 서명(CS)를 복호화 하여 해시값(HASH1)을 구한다.
Hash(INFO_LIST) =&gt; HASH1'                    // 필요한 정보(INFO_LIST)를 직접 해시하여 해시값(HASH1')를 구한다.
If HASH1 == HASH1', Execute C1 =&gt; Very Good! // 두 해시값이 일치한다면, 필요한 정보(INFO_LIST)들은 변조된적이 없는 것이고, 배포자의 공개키(KeyD) 역시 변조되지 않았음을 증명한다.
</code></pre>
<p>그럼 위에서 뜬금없이 나온 인증기관의 공개키(CKeyD) 는 어디서 인증할 것인가? 배포자의 공개키(KeyD)를 인증한 방법으로 상위 기관의 인증서로 인증을 한다. 이렇게 상위 기관의 인증서로 하위 인증기관의 공개키를 검증하는 것을 인증서 체인이라고 하고, 인증서 체인을 따라올라가다보면 최상위 인증기관(Root CA, 스스로를 인증함)을 만날 수 있는데, 최상위 인증서는 무조건 신뢰한다고 가정하고 이 모든 인증을 진행하는 것이다.</p>
<p>아래와 같이 최상위 인증서의 발급대상과 발급자가 같다.</p>
<p><img src="#" post-src="2019-08-19-https-ssl-tls-01.PNG" /></p>
<blockquote>
<p>긴 여정 이었다. 휴!</p>
</blockquote>
<h4 id="tls_1"><a class="toclink" href="../../2019/08/19/https-tls-ssl-%EC%A0%84%EC%9E%90%EC%84%9C%EB%AA%85/#tls_1">TLS 관련 확장자들</a></h4>
<pre><code class="language-yaml">.pem :
  - X.509 v3 파일의 한 형태
  - Privacy Enhanced Mail 은 Base64인코딩된 ASCII text file.
  - 원래는 secure email에 사용되는 인코딩 포멧이었는데 더이상 email쪽에서는 잘 쓰이지 않고 인증서 또는 키값을 저장하는데 많이 사용.
  - -----BEGIN XXX----- , -----END XXX----- 로 묶여있는 text file을 보면 이 형식으로 인코딩. (담고있는 내용에 따라 XXX 위치에 CERTIFICATE, RSA PRIVATE KEY 등을 사용)
  - 인증서(Certificate = public key), 비밀키(private key), 인증서 발급 요청을 위해 생성하는 CSR (certificate signing request) 등을 저장하는데 사용.

.crt/.cer : 인증서를 나타내는 확장자. (cer은 MS 제품군에서 많이 사용, crt는 unix, linux 계열에서 많이 사용.)

.key : 개인 또는 공개 PKCS#8 키를 의미
</code></pre>
<h4 id="_2"><a class="toclink" href="../../2019/08/19/https-tls-ssl-%EC%A0%84%EC%9E%90%EC%84%9C%EB%AA%85/#_2">인증서가 한개가 아니야?</a></h4>
<p><code>DV(Domain Validation)</code> 인증서는 인증서를 발급한 요청자가 그 도메인의 소유주가 맞는지만을 확인하여 발급을 하기 때문에, 비용만 내면 아무나 인증서를 발급 받을 수 있다. 이런 문제를 해결하기 위해 <code>EV-SSL</code> 이 나왔다.</p>
<p><code>EV-SSL</code> 은 공신력 있는 인증 기관에서 더욱 엄격한 심사 기준으로 발급한 <code>EV(Extended Validation)</code> 인증서를 사용하여 보안을 강화한 프로토콜이다. 상위</p>
<blockquote>
<p>EV 인증서를 발급 받기 위해서는 까다로운 인증절차 및 신원보증 등이 확인되어야만 구축이 가능하기 때문에 피싱(Phishing)과 파밍(Pharming) 등의 공격으로부터 엔드 유저와 일반 사용자를 보호할 수 있습니다.</p>
<p>어찌 선점 고인물 같은데</p>
</blockquote>
<p>출처
- <a href="https://ko.wikipedia.org/wiki/%EC%84%9C%EB%AA%85">서명</a>
- <a href="https://www.letmecompile.com/certificate-file-format-extensions-comparison/">인증서 파일 형식 및 확장자의 차이점 비교 설명 (Certificate file format &amp; extensions)</a>
- <a href="https://d2.naver.com/helloworld/744920">네이버 애플리케이션의 전자 서명 원리</a></p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-08-19 00:00:00+00:00">August 19, 2019</time></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="tomcat-ssl"><a class="toclink" href="../../2019/08/19/tomcat-%EC%97%90-ssl-%EC%A0%81%EC%9A%A9/">TOMCAT 에 SSL 적용</a></h2>
<blockquote>
<p>아래 내용을 다시 해보려니 뭔가 안되서 다시 작성합니다. <a href="{{ site.url }}/apply-tls-to-tomcat-custom-openssl-certification2/">여기로</a></p>
<p>apache-tomcat-9.0.14 에 적용했다.</p>
</blockquote>
<h4 id="1-openssl"><a class="toclink" href="../../2019/08/19/tomcat-%EC%97%90-ssl-%EC%A0%81%EC%9A%A9/#1-openssl">1. OpenSSL 프로그램을 다운받자</a></h4>
<p><a href="https://sourceforge.net/projects/openssl/">OpenSSL</a> 그냥 다운 받아서 압축 풀면 됨..</p>
<h4 id="2"><a class="toclink" href="../../2019/08/19/tomcat-%EC%97%90-ssl-%EC%A0%81%EC%9A%A9/#2">2. 개인키를 만들자</a></h4>
<p>다운받은 <code>OpenSSL</code> 을 실행시켜서 아래 명령어를 입력해 준다.</p>
<pre><code class="language-shell"># 이렇게 하면 password 가 있는 개인키가 나온다.
genrsa -des3 -out &lt;MY PRIVATE KEY FILE NAME&gt; 2048

# EXAMPLE
OpenSSL&gt; genrsa -des3 -out delete.me.plz.private.key 2048
Generating RSA private key, 2048 bit long modulus
............................+++
.........................................+++
unable to write 'random state'
e is 65537 (0x10001)
Enter pass phrase for delete.me.plz.private.key: &lt;TYPE MY PASSWORD&gt;
Verifying - Enter pass phrase for delete.me.plz.private.key: &lt;TYPE MY PASSWORD&gt;

# 비밀번호가 없는 개인키 만들기
genrsa -out &lt;MY PRIVATE KEY FILE NAME&gt; 2048
</code></pre>
<h4 id="3"><a class="toclink" href="../../2019/08/19/tomcat-%EC%97%90-ssl-%EC%A0%81%EC%9A%A9/#3">3. 개인키를 만들었으면 대응되는 공개키를 만들자.</a></h4>
<pre><code class="language-shell">rsa -in &lt;MY PRIVATE KEY FILE NAME&gt; -pubout -out &lt;MY PUBLIC KEY FILE NAME&gt;

# EXAMPLE
OpenSSL&gt; rsa -in delete.me.plz.private.key -pubout -out delete.me.plz.public.key
Enter pass phrase for delete.me.plz.private.key: &lt;TYPE MY PASSWORD&gt;
writing RSA key
</code></pre>
<h4 id="4-csr"><a class="toclink" href="../../2019/08/19/tomcat-%EC%97%90-ssl-%EC%A0%81%EC%9A%A9/#4-csr">4. <code>CSR</code> 인증요청서를 만들자.</a></h4>
<p><code>CSR</code> 은 <code>Certificate Signing Request</code> 로 <code>SSL</code> 서버를 운영하는 회사의 정보를 암호화하여 인증기관으로 보내 인증서를 발급받게 하는 신청서이다.</p>
<pre><code class="language-shell">req -new -key &lt;MY PRIVATE KEY FILE NAME&gt; -out &lt;MY CSR FILE NAME&gt;

# EXAMPLE
OpenSSL&gt; req -new -key delete.me.plz.private.key -out delete.me.plz.csr
Unable to load config info from C:/OpenSSL/openssl.cnf
error in req
</code></pre>
<p>근데 저렇게 나와서 찾다보니 옵션을 주면 된단다.
참고로 처음 기동할때도 이런 메세지를 보여줬는데..</p>
<pre><code>WARNING: can't open config file: C:/OpenSSL/openssl.cnf
</code></pre>
<p>아무튼...</p>
<pre><code class="language-shell">req -config &lt;LOCATION OF openssl.cnf FILE&gt; -new -key &lt;MY PRIVATE KEY FILE NAME&gt; -out &lt;MY CSR FILE NAME&gt;

# EXAMPLE
OpenSSL&gt; req -config ./openssl.cnf -new -key delete.me.plz.private.key -out delete.me.plz.csr
Enter pass phrase for delete.me.plz.private.key:
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:KR
State or Province Name (full name) [Some-State]:Seoul
Locality Name (eg, city) []:Seoul
Organization Name (eg, company) [Internet Widgits Pty Ltd]:HARM
Organizational Unit Name (eg, section) []:harm
Common Name (e.g. server FQDN or YOUR name) []:epu baal
Email Address []:herdin86@gmail.com

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:1234
An optional company name []:harm
</code></pre>
<p>저렇게 하면 된다.<br />
저런 뒤, 만들어진 <code>CSR</code> 파일을 열어보면</p>
<pre><code>-----BEGIN CERTIFICATE REQUEST-----
어쩌구저쩌구알수없는암호화문자열들...
-----END CERTIFICATE REQUEST-----
</code></pre>
<p>위와 같은 양식의 요청서를 볼 수 있다. 여기까지했으면, <code>CA(Certificate Authority)</code> 인증 기관에 요청하여 <code>CRT(CeRTificate)</code> 파일을 받을 수 있다.</p>
<blockquote>
<p>뭐 메일로 받는다던데.. 안해봐서..</p>
</blockquote>
<p>하지만 요청하고 다시 회신받고 귀찮고 난 그냥 로컬서버에 tomcat 이 https 요청을 받아주기만 할 수 있으면 되기 때문에 사설 CA 를 만들고 진행한다.</p>
<h4 id="5-root-ca"><a class="toclink" href="../../2019/08/19/tomcat-%EC%97%90-ssl-%EC%A0%81%EC%9A%A9/#5-root-ca">5. root CA 만들기</a></h4>
<p>인증서에 서명을 할 root CA 를 만든다.</p>
<pre><code class="language-shell">genrsa -aes256 -out &lt;ROOT CA FILE NAME&gt; 2048

# EXAMPLE
OpenSSL&gt; genrsa -aes256 -out rootCA.key 2048
Generating RSA private key, 2048 bit long modulus
........................................................+++
.....................................................................+++
e is 65537 (0x10001)
Enter pass phrase for rootCA.key:
Verifying - Enter pass phrase for rootCA.key:
</code></pre>
<h4 id="6-root-ca-csr"><a class="toclink" href="../../2019/08/19/tomcat-%EC%97%90-ssl-%EC%A0%81%EC%9A%A9/#6-root-ca-csr">6.  root CA 사설 CSR 생성하기</a></h4>
<p>위에서 만든 root CA 를 이용하여 사설 CSR 을 만든다.</p>
<blockquote>
<p>위에서 CSR 만들었는데 왜 또 만들지? 잘모르겠지만 root CA 의 CSR 과 개인 CSR 이 둘다 필요한 것 같다. 확장자는 중요하지 않은 것 같다.</p>
</blockquote>
<pre><code class="language-shell">req -x509 -new -nodes -key &lt;ROOT CA FILE NAME&gt; -days 3650 -out &lt;ROOT CA CSR FILE NAME&gt;

# EXAMPLE
OpenSSL&gt; req -config ./openssl.cnf -x509 -nodes -key rootCA.key -days 3650 -out rootCSR.pem
Enter pass phrase for rootCA.key:
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:KR
State or Province Name (full name) [Some-State]:Seoul
Locality Name (eg, city) []:Seoul
Organization Name (eg, company) [Internet Widgits Pty Ltd]:HARM
Organizational Unit Name (eg, section) []:harm
Common Name (e.g. server FQDN or YOUR name) []:epu baal
Email Address []:herdin86@gmail.com
</code></pre>
<h4 id="7-crt"><a class="toclink" href="../../2019/08/19/tomcat-%EC%97%90-ssl-%EC%A0%81%EC%9A%A9/#7-crt">7. CRT 인증서 생성하기</a></h4>
<pre><code class="language-shell">
x509 -req -in &lt;MY CSR FILE NAME&gt; -CA &lt;ROOT CA CSR FILE NAME&gt; -CAkey &lt;ROOT CA FILE NAME&gt; -CAcreateserial -out &lt;MY CRT FILE NAME&gt; -days 3650

x509 -req -in private.csr -CA rootCSR.pem -CAkey rootCA.key -CAcreateserial -out private.crt -days 3650
</code></pre>
<h4 id="8-tomcat"><a class="toclink" href="../../2019/08/19/tomcat-%EC%97%90-ssl-%EC%A0%81%EC%9A%A9/#8-tomcat">8. tomcat 에 적용하기 위해 형식 변경</a></h4>
<pre><code class="language-shell">pkcs12 -export -in &lt;MY CRT FILE NAME&gt; -inkey &lt;MY PRIVATE KEY FILE NAME&gt; -out &lt;MY PKCS12 FILE NAME FOR TOMCAT&gt; -name &lt;NAME-여긴 뭘적는건지 모르겠다&gt;

pkcs12 -export -in private.crt -inkey private.key -out .keystore -name tomcat
</code></pre>
<h4 id="9-tomcat-https"><a class="toclink" href="../../2019/08/19/tomcat-%EC%97%90-ssl-%EC%A0%81%EC%9A%A9/#9-tomcat-https">9. tomcat 에 HTTPS 커넥터 적용</a></h4>
<p>tomcat <code>server.xml</code> 에 아래 내용을 추가한다. 대소문자를 잘 입력하도록하자.
다른 블로그에서 참고하다가 <code>attribute</code> 의 대소문자 때문에 안되서 몇시간 낭비했다.</p>
<pre><code class="language-xml">&lt;Connector port=&quot;8443&quot; protocol=&quot;org.apache.coyote.http11.Http11NioProtocol&quot;
        maxThreads=&quot;150&quot;
        scheme=&quot;https&quot;
        secure=&quot;true&quot;
        SSLEnabled=&quot;true&quot;

        keystorePass=&quot;&lt;MY PKCS12 FILE EXPORT PASSWORD&gt;&quot;
        keystoreFile=&quot;&lt;MY PKCS12 FILE NAME FOR TOMCAT&gt;&quot;

        clientAuth=&quot;false&quot;
        sslProtocol=&quot;TLS&quot;
/&gt;
</code></pre>
<h4 id="10"><a class="toclink" href="../../2019/08/19/tomcat-%EC%97%90-ssl-%EC%A0%81%EC%9A%A9/#10">10. 확인</a></h4>
<p><code>https://MY-DOMAIN:8443</code> 에 접속하여 확인해 보자.</p>
<p>끝.</p>
<p>연관 포스트들
- <a href="{{ site.url }}/2019/08/19/https-ssl-tls">HTTPS</a>
- <a href="{{ site.url }}/2019/08/21/encryption">대칭키와 공개키</a></p>
<p>참고 포스트들
- <a href="https://namjackson.tistory.com/24">OpenSSL 을 이용한 SSL 인증서 발급</a>
- <a href="https://namjackson.tistory.com/25">SSL TOMCAT 적용1</a>
- <a href="https://joshuajangblog.wordpress.com/tag/%ED%86%B0%EC%BA%A3-ssl-%EC%84%A4%EC%A0%95%EB%B0%A9%EB%B2%95/">SSL TOMCAT 적용2</a></p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-08-16 00:00:00+00:00">August 16, 2019</time></li>
        
        
          
          <li class="md-meta__item">
            
              1 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="grisette-style"><a class="toclink" href="../../2019/08/16/grisette-style/">Grisette style</a></h2>
<p><a href="https://en.wikipedia.org/wiki/Grisette_(beer)">Grisette on wiki</a></p>
<p><img alt="grisette" src="/assets/images/posts/2019-08-16-beer-grisette-01.jpg" /></p>
<p><img alt="grisette on menu" src="/assets/images/posts/2019-08-16-beer-grisette-02.jpg" /></p>
<blockquote>
<p><a href="https://www.seoulbrewery.com">서울브루어리 합정점</a> 에서 처음 먹어 본 스타일로 처음보는 스타일이라 직원에게 그리셋이 뭐냐고 했더니 앵무새처럼 그리셋이 그리셋이다 라고 대답해서 당황했던 기억이 난다. 광부의 세종이라고 하면 알아먹었을텐데 세상은 멍청한 사람에게 친절하지 않다.</p>
</blockquote>
<p>프랑스와 벨기에 경계의 광산지대에서 유래된 맥주이다. <code>Grisette</code> 이란 명칭은 <code>little grey one</code> 이라는 해당 지역의 회색 돌 또는 맥주를 서빙하던 여성의 회색 드레스 에서 유래되었다고 한다. 낮은 도수에 라이트바디, 다른 세종처럼 시큼한 맛이다.</p>
<blockquote>
<p>시간이 좀 지난 뒤 쓰는 글이라 기억이 명확하진 않지만, 웰컴썸머그리셋은 풀향이 짙게 났던 것 같다.
미각이 둔해서 섬세하게 느끼지 못하기 때문에 맛이 강하거나 독특하면 기억에 남는다.
직원분들 쿨내가 진동하지만 다시 한번 가서 먹어보고 싶다.</p>
</blockquote>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-08-16 00:00:00+00:00">August 16, 2019</time></li>
        
        
          
          <li class="md-meta__item">
            
              2 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="facade-pattern"><a class="toclink" href="../../2019/08/16/facade-pattern/">Facade pattern</a></h2>
<p>Facade 의 사전적 의미</p>
<blockquote>
<p>파사드(프랑스어: Façade)는 건물의 출입구로 이용되는 정면 외벽 부분을 가리키는 말이다.<br />
한글화하여 순화하려면 '정면'(正面)이 무난할 것으로 여겨진다.
건축에서 파사드의 궁극적 목적은 '소통'이다. 건물의 입면이 다양해지면서 파사드는 건물 외피 전체를 의미하기도 한다.
<a href="https://ko.wikipedia.org/wiki/파사드">wiki</a></p>
</blockquote>
<p>어떤 작업을 할때 작업단위의 일련의 작업을 한다고하면, 일련의 작업을 단순화 시키는 패턴을 의미한다. <a href="https://ko.wikipedia.org/wiki/퍼사드_패턴">좀더 자세하고 명확한 해설은 wiki 로</a></p>
<p>똥을 싸기위해</p>
<ol>
<li>양변기뚜껑을 열고</li>
<li>바지를 내리고</li>
<li>팬티를 내리고</li>
<li>힘을 준다</li>
</ol>
<p>라는 일련의 작업이 있으면 이를</p>
<ol>
<li>똥을 싼다.</li>
</ol>
<p>로 줄이는 것을 말한다.</p>
<p>코드로 보면..</p>
<p>먼저 변기 클래스</p>
<pre><code class="language-java">package com.harm.unit.pattern.facade;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class Toilet {
    private Logger logger = LoggerFactory.getLogger(Toilet.class);
    public int openCover(int sequence) throws Exception {
        if(sequence == 0) {
            this.logger.debug(&quot;OPEN COVER&quot;);
        } else {
            throw new Exception(&quot;NO PROPER SEQUENCE&quot;);
        }
        return ++sequence;
    }
}
</code></pre>
<p>바지 클래스</p>
<pre><code class="language-java">package com.harm.unit.pattern.facade;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class Pants {
    private Logger logger = LoggerFactory.getLogger(Pants.class);
    public int lower(int sequence) throws Exception {
        if(sequence == 1) {
            this.logger.debug(&quot;LOWER PANTS&quot;);
        } else {
            throw new Exception(&quot;NO PROPER SEQUENCE&quot;);
        }
        return ++sequence;
    }
}
</code></pre>
<p>팬티 클래스</p>
<pre><code class="language-java">package com.harm.unit.pattern.facade;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class Underwear {
    private Logger logger = LoggerFactory.getLogger(Underwear.class);
    public int lower(int sequence) throws Exception {
        if(sequence == 2) {
            this.logger.debug(&quot;LOWER UNDERWEAR&quot;);
        } else {
            throw new Exception(&quot;NO PROPER SEQUENCE&quot;);
        }
        return ++sequence;
    }
}
</code></pre>
<p>궁둥이 클래스</p>
<pre><code class="language-java">package com.harm.unit.pattern.facade;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class Ass {
    private Logger logger = LoggerFactory.getLogger(Ass.class);
    public int bigShoot(int sequence) throws Exception {
        if(sequence == 3) {
            this.logger.debug(&quot;POOOOOOOOOOOOOOOO-POOOOOOOOOOOOOOOO-&quot;);
        } else {
            throw new Exception(&quot;NO PROPER SEQUENCE&quot;);
        }
        return ++sequence;
    }
}
</code></pre>
<p>위의 <code>Toilet</code>, <code>Pants</code>, <code>Underwear</code>, <code>Ass</code> class 들은 논리적으로 긴밀하게 연결되어 있다.<br />
순서가 잘못되면 오류가 난다. 위의 4개의 class 를 이용해서 똥을 싸려면.</p>
<pre><code class="language-java">package com.harm.unit.pattern.facade;

import com.harm.unit.Unit;

public class FacadeStudy001 implements Unit {

    @Override
    public Object execute(Object[] obj) throws Exception {
        int sequence = -1;

        sequence = 0;
        sequence = new Toilet().openCover(sequence);
        sequence = new Pants().lower(sequence);
        sequence = new Underwear().lower(sequence);
        sequence = new Ass().bigShoot(sequence);

        return null;
    }
}
</code></pre>
<p>위와 같은 과정을 거쳐야 하지만...<br />
<code>Facade</code> pattern 을 적용한 <code>DoNumberTwo</code> class 를 설계한다면..</p>
<pre><code class="language-java">package com.harm.unit.pattern.facade;

public class DoNumberTwo {
    private Toilet toilet;
    private Pants pants;
    private Underwear underwear;
    private Ass ass;
    public DoNumberTwo(Toilet toilet, Pants pants, Underwear underwear, Ass ass) {
        this.toilet = toilet;
        this.pants = pants;
        this.underwear = underwear;
        this.ass = ass;
    }
    public void bigShoot(int sequence) throws Exception {
        sequence = this.toilet.openCover(sequence);
        sequence = this.pants.lower(sequence);
        sequence = this.underwear.lower(sequence);
        sequence = this.ass.bigShot(sequence);
    }
}
</code></pre>
<p>아래와 같이 코드가 줄어듬과 동시에 가독성이 좋아지게 된다.</p>
<pre><code class="language-java">package com.harm.unit.pattern.facade;

import com.harm.unit.Unit;

public class FacadeStudy001 implements Unit {

    @Override
    public Object execute(Object[] obj) throws Exception {
        int sequence = -1;

        sequence = 0;
        new DoNumberTwo(new Toilet(), new Pants(), new Underwear(), new Ass()).bigShoot(sequence);

        return null;
    }
}
</code></pre>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  <a class="md-pagination__link" href="../../">1</a> <a class="md-pagination__link" href="../2/">2</a> <a class="md-pagination__link" href="../3/">3</a> <span class="md-pagination__current">4</span> <a class="md-pagination__link" href="../5/">5</a> <a class="md-pagination__link" href="../6/">6</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../9/">9</a>
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": {"Compatibility": "compat", "rabbitmq": "rabbitmq"}, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f13b1293.min.js"></script>
      
    
  </body>
</html>