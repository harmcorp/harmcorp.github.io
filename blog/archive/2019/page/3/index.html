
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://harmcorp.github.io/blog/archive/2019/page/3/">
      
      
        <link rel="prev" href="../../../2025/">
      
      
      
      <link rel="icon" href="../../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.2">
    
    
      
        <title>2019 - HARM CORP</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.d7758b05.min.css">
      
      


  
  
    
    
      
    
    
  
  
  <style>.md-tag.md-tag--rabbitmq{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M23.035 9.601h-7.677a.956.956 0 0 1-.962-.962V.962a.956.956 0 0 0-.962-.956H10.56a.956.956 0 0 0-.962.956V8.64a.956.956 0 0 1-.962.962H5.762a.956.956 0 0 1-.961-.962V.962A.956.956 0 0 0 3.839 0H.959a.956.956 0 0 0-.956.962v22.076A.956.956 0 0 0 .965 24h22.07a.956.956 0 0 0 .962-.962V10.58a.956.956 0 0 0-.962-.98zm-3.86 8.152a1.437 1.437 0 0 1-1.437 1.443h-1.924a1.437 1.437 0 0 1-1.436-1.443v-1.917a1.437 1.437 0 0 1 1.436-1.443h1.924a1.437 1.437 0 0 1 1.437 1.443z"/></svg>');}</style>

    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#2019" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../.." title="HARM CORP" class="md-header__button md-logo" aria-label="HARM CORP" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            HARM CORP
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2019
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="HARM CORP" class="md-nav__button md-logo" aria-label="HARM CORP" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    HARM CORP
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Blog
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    this is blog index!
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tags
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_3" checked>
        
          
          <label class="md-nav__link" for="__nav_1_3" id="__nav_1_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Archive
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1_3">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../2025/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2025
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
      
    
  
  
    <li class="md-nav__item">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="../../" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    2019
    
  </span>
  

      </a>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_4" >
        
          
          <label class="md-nav__link" for="__nav_1_4" id="__nav_1_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Categories
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_4">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/holidays/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Holidays
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="2019">2019</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-09-26 00:00:00+00:00">September 26, 2019</time></li>
        
        
          
          <li class="md-meta__item">
            
              1 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="closure"><a class="toclink" href="../../../../2019/09/26/%ED%81%B4%EB%A1%9C%EC%A0%B8closure%EA%B0%80-%EB%AD%90%EC%A7%80/">클로져(Closure)가 뭐지?</a></h2>
<p>클로져란</p>
<p><a href="https://futurecreator.github.io/2018/08/09/java-lambda-and-closure/">참고</a></p>
<blockquote>
<ul>
<li>외부 범위의 변수를 함수 내부로 바인딩하는 기술.</li>
<li>함수를 만들고 그 함수 내부의 코드가 탐색하는 스코프를 (함수 생성 당시의) 렉시컬 스코프로 고정한 것.</li>
</ul>
</blockquote>
<pre><code class="language-javascript">function produceAddFunc(x) {
  return function(y) {
    return x + y;
  }
}
</code></pre>
<p><code>produceAddFunc</code> 함수는 함수를 반환하는데, 반환되는 함수는 전달받은 파라미터에 <code>produceAddFunc</code> 함수의 파라미터를 더해서 반환하는 함수이다.
<code>produceAddFunc</code> 함수가 종료되더라도 x 값이 유지가 되는데 이를 클로저라 한다.</p>
<p>주어진 <code>context</code> 바깥의 변수를 참조 하는 경우를 클로져라 보면 될 것 같다.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-09-26 00:00:00+00:00">September 26, 2019</time></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="accepted-socket"><a class="toclink" href="../../../../2019/09/26/accepted-socket-%EC%9D%98-%EC%83%81%ED%83%9C%EA%B0%80/">Accepted Socket 의 상태가...?</a></h2>
<p>이 <a href="{{ site.url }}/tcp-time-wait/">포스트</a>를 정리하다가 나만 모르는 놀라운 정보를 알게 되었다.
<code>ServerSocket</code> 에서 <code>accept()</code> 시 반환 되는 server socket(client socket 과 연동 된) 의 포트가 서버의 listening socket 포트와 같다는 것...</p>
<pre><code class="language-java">...
ServerSocket serverSocket = new ServerSocket(3000);
...
Socket socket = serverSocket.accept();
...
</code></pre>
<blockquote>
<p>위의 코드에서 <code>accept()</code> 반환받는 Socket 객체에 바인딩 된 포트는 내 상식으로는 3000 이 커널에서 선택한 유휴포트로 알고 있었다.
그런데 그게 이제 아닌가보다..... 이상하다 학부때는 분명 그렇게 배운 것 같았는데............ 언제부터 바뀐건지 원래 잘못 알고있었던건지 알 수 가 없다...</p>
</blockquote>
<p>이 <a href="http://docs.likejazz.com/time-wait/">포스트</a> 에 따르면,  서버에서 사용할 수 있는 포트의 갯수는 3 ~ 6 만개 이다.</p>
<pre><code class="language-shell">$ sysctl net.ipv4.ip_local_port_range
net.ipv4.ip_local_port_range = 32768    60999
</code></pre>
<p>파일디스크립터의 갯수는 가변적이지만,</p>
<pre><code class="language-shell">$ sysctl fs.file-max
fs.file-max = 57545
</code></pre>
<p>늘릴 수 있다고한다. 26만개 이상?</p>
<p>그런데 위의 포스트에선 TIME_WAIT 상태인 소켓을 9만개인 것을 확인 했단다..</p>
<blockquote>
<p>아니 이게 무슨말이오</p>
</blockquote>
<p>소켓 하나에 서버의 로컬포트가 1개 씩 바인딩 된다고 하면 저건 말이 안된다.</p>
<p>그래서 나도 간단하게 확인만 해보았다..</p>
<p><a href="https://github.com/herdin/SimpleJava/blob/master/src/main/java/com/harm/unit/io/network/SocketStudy0101.java">서버 소스</a>, <a href="https://github.com/herdin/SimpleJava/blob/master/src/main/java/com/harm/unit/io/network/SocketStudy0102.java">클라이언트 소스</a>  </p>
<p>서버는 단순한 에코 서버이고 클라이언트를 여러개 상대한다..</p>
<h4 id="_1"><a class="toclink" href="../../../../2019/09/26/accepted-socket-%EC%9D%98-%EC%83%81%ED%83%9C%EA%B0%80/#_1">서버측 로그</a></h4>
<pre><code class="language-shell">2019-09-27 17:19:29.505 DEBUG --- [ main ] c.h.u.DefaultUnitHandler : ----------------------------------------
2019-09-27 17:19:29.509 DEBUG --- [ main ] c.h.u.DefaultUnitHandler : | START TIME : 20190927171929
2019-09-27 17:19:29.522 DEBUG --- [ main ] c.h.u.DefaultUnitHandler : | SocketStudy0101 STARTED
2019-09-27 17:19:29.525 DEBUG --- [ main ] c.h.u.DefaultUnitHandler : ........................................
2019-09-27 17:19:29.529 DEBUG --- [ main ] c.h.u.i.n.SocketStudy0101 : SERVER SOCKER CREATION.
2019-09-27 17:19:56.385 DEBUG --- [ main ] c.h.u.i.n.SocketStudy0101 : ACCEPT LOCAL /127.0.0.1:3000 REMOTE /127.0.0.1:54133
2019-09-27 17:19:56.388 DEBUG --- [ Thread-0 ] c.h.u.i.n.SocketStudy0101$1Worker : WORKER0 THREAD START LOCAL /127.0.0.1:3000 REMOTE /127.0.0.1:54133
2019-09-27 17:19:59.362 DEBUG --- [ main ] c.h.u.i.n.SocketStudy0101 : ACCEPT LOCAL /127.0.0.1:3000 REMOTE /127.0.0.1:54139
2019-09-27 17:19:59.363 DEBUG --- [ Thread-1 ] c.h.u.i.n.SocketStudy0101$1Worker : WORKER1 THREAD START LOCAL /127.0.0.1:3000 REMOTE /127.0.0.1:54139
2019-09-27 17:20:29.659 DEBUG --- [ Thread-0 ] c.h.u.i.n.SocketStudy0101$1Worker : RECV 첫번째 클라이언트에서 보낸 메세지
2019-09-27 17:20:46.056 DEBUG --- [ Thread-1 ] c.h.u.i.n.SocketStudy0101$1Worker : RECV 두번째 클라이언트에서 보낸 메세지
</code></pre>
<h4 id="_2"><a class="toclink" href="../../../../2019/09/26/accepted-socket-%EC%9D%98-%EC%83%81%ED%83%9C%EA%B0%80/#_2">첫번째 클라이언트 로그</a></h4>
<pre><code class="language-shell">2019-09-27 17:19:56.377 DEBUG --- [ main ] c.h.u.DefaultUnitHandler : ----------------------------------------
2019-09-27 17:19:56.382 DEBUG --- [ main ] c.h.u.DefaultUnitHandler : | START TIME : 20190927171956
2019-09-27 17:19:56.384 DEBUG --- [ main ] c.h.u.DefaultUnitHandler : | SocketStudy0102 STARTED
2019-09-27 17:19:56.384 DEBUG --- [ main ] c.h.u.DefaultUnitHandler : ........................................
2019-09-27 17:19:56.385 DEBUG --- [ main ] c.h.u.i.n.SocketStudy0102 : CLIENT SOCKET CREATION
2019-09-27 17:19:56.387 DEBUG --- [ main ] c.h.u.i.n.SocketStudy0102 : TYPE MESSAGE :
첫번째 클라이언트에서 보낸 메세지
2019-09-27 17:20:29.660 DEBUG --- [ main ] c.h.u.i.n.SocketStudy0102 : RECV WORKER0[첫번째 클라이언트에서 보낸 메세지]
2019-09-27 17:20:29.660 DEBUG --- [ main ] c.h.u.i.n.SocketStudy0102 : TYPE MESSAGE :
</code></pre>
<h4 id="_3"><a class="toclink" href="../../../../2019/09/26/accepted-socket-%EC%9D%98-%EC%83%81%ED%83%9C%EA%B0%80/#_3">두번째 클라이언트 로그</a></h4>
<pre><code class="language-shell">2019-09-27 17:19:59.354 DEBUG --- [ main ] c.h.u.DefaultUnitHandler : ----------------------------------------
2019-09-27 17:19:59.359 DEBUG --- [ main ] c.h.u.DefaultUnitHandler : | START TIME : 20190927171959
2019-09-27 17:19:59.361 DEBUG --- [ main ] c.h.u.DefaultUnitHandler : | SocketStudy0102 STARTED
2019-09-27 17:19:59.361 DEBUG --- [ main ] c.h.u.DefaultUnitHandler : ........................................
2019-09-27 17:19:59.362 DEBUG --- [ main ] c.h.u.i.n.SocketStudy0102 : CLIENT SOCKET CREATION
2019-09-27 17:19:59.363 DEBUG --- [ main ] c.h.u.i.n.SocketStudy0102 : TYPE MESSAGE :
두번째 클라이언트에서 보낸 메세지
2019-09-27 17:20:46.058 DEBUG --- [ main ] c.h.u.i.n.SocketStudy0102 : RECV WORKER1[두번째 클라이언트에서 보낸 메세지]
2019-09-27 17:20:46.059 DEBUG --- [ main ] c.h.u.i.n.SocketStudy0102 : TYPE MESSAGE :
</code></pre>
<p>아니.. 리모트는 다른데 로컬포트가 같애 이게 어떻게된거지..</p>
<h4 id="_4"><a class="toclink" href="../../../../2019/09/26/accepted-socket-%EC%9D%98-%EC%83%81%ED%83%9C%EA%B0%80/#_4">결론</a></h4>
<p>소켓은 <code>&lt;protocol&gt;</code>, <code>&lt;src addr&gt;</code>, <code>&lt;src port&gt;</code>, <code>&lt;dest addr&gt;</code>, <code>&lt;dest port&gt;</code> 이 5개 값이 유니크하게 구성된다. 따라서 서버 포트가 추가되거나 클라이언트의 IP가 추가될 경우 그 만큼의 새로운 쌍을 생성할 수 있어 TIME_WAIT가 많이 남아 있어도 별 문제가 없다.</p>
<p>라고 한다.. 대체 언제부터 바뀐걸까.. 내가 잘못알고 있었던걸까.. 흑흑..</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-09-26 00:00:00+00:00">September 26, 2019</time></li>
        
        
          
          <li class="md-meta__item">
            
              2 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="tcp-time_wait"><a class="toclink" href="../../../../2019/09/26/tcp-time_wait-%EC%97%90-%EB%8C%80%ED%95%B4%EC%84%9C/">TCP TIME_WAIT 에 대해서</a></h2>
<p><a href="http://blog.daum.net/_blog/BlogTypeView.do?blogid=0RxIq&amp;articleno=268&amp;_bloghome_menu=recenttext">정리 대상 블로그</a></p>
<p>접속시작할때, 3-way Handshake
<img alt="image" src="/assets/images/posts/2019-09-26-tcp-time-wait-01.gif" /></p>
<p>접속종료할때, 4-way Handshake
<img alt="image" src="/assets/images/posts/2019-09-26-tcp-time-wait-02.gif" /></p>
<p>접속을 종료할때,<br />
Client 에서 FIN 을 보내고 Server 의 Ack 를 받은 다음,
Server 에서 FIN 을 보내고 Client 의 Ack 를 받으면 Client 와 Server 는 소켓을 닫기전에 서로 정리해야될 일들이 끝난 상태이다.</p>
<p>Server 의 FIN 을 보내기 전에 Server 에서 보낸 패킷이 FIN 보다 늦게 Client 에 도착하게 된다면 패킷이 유실되게 된다.<br />
위와 같이 데이터가 유실되는 경우를 막기 위해 Server 의 FIN 을 받은 Client 의 소켓은 TIME_WAIT 상태가 되는데 기본적으로 2MSL(60초) 동안 기다리면서 유실될 수 있는(늦게도착하는) 패킷을 기다린다고 한다.</p>
<p>순서를 보장하지 않는 네트워크 환경 때문에 유실될 수 있는 문제를 해결하고자 만든 TIME_WAIT 는 오히려 Server 쪽에 문제를 발생 시킬 수 있는데, 그냥 기다리는 소켓이 많아지게 되면 Server 에 부하+소켓부족으로 제 기능을 못하게 될 수 가 있다.</p>
<p>LINGER 옵션 : OS 옵션으로 closesocket()를 호출했을 때 아직 전송되지 않은 SendBuffer 의 데이터의 처리옵션</p>
<p><code>LINGER.l_onoff = 1, LINGER.l_linger = 0</code>
- closesocket() 즉시 반환
- 버퍼의 데이터 버림
- 비정상종료(Abortive Shutdown) -&gt; TIME_WAIT 가 남지 않음</p>
<p><code>LINGER.l_onoff = 1, LINGER.l_linger = non-zero</code>
- 정상적인 종료가 될 때 까지 closesocket() 반환하지 않음
- 정상적인 종료과정(Graceful Shutdown) 진행. LINGER.l_linger (초) 만큼 대기 후 정상종료가 되지 않으면 비정상종료진행(closesocket() 즉시 반환 및 버퍼의 데이터 버림).</p>
<p><code>LINGER.l_onoff = 0</code>
- closesocket() 즉시 반환
- 정상적인 종료과정(Graceful Shutdown) 을 Background 로 진행.
- 언제 종료됐는지 알 수 없음.</p>
<p>접속을 종료를 먼저 시도(closesocket() 호출)하는 쪽에 TIME_WAIT 가 남기 때문에, Server 가 아니라 Client 에서 먼저 접속 종료를 시도를 해야 Server 에 TIME_WAIT 가 남지 않는다.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-09-23 00:00:00+00:00">September 23, 2019</time></li>
        
        
          
          <li class="md-meta__item">
            
              2 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="xss-csrfxsrf-same-origin-policy-cors"><a class="toclink" href="../../../../2019/09/23/xss-csrfxsrf-same-origin-policy-cors/">XSS, CSRF/XSRF, Same-Origin policy, CORS</a></h2>
<p>웹취약점이라고 자주 듣는 단어들이 있는데, 듣기만 자주 듣고 뭔지 정확히 모르니 짜증나서 정리한다</p>
<h3 id="xss-cross-site-scripting"><a class="toclink" href="../../../../2019/09/23/xss-csrfxsrf-same-origin-policy-cors/#xss-cross-site-scripting">XSS (Cross-Site Scripting)</a></h3>
<p><a href="https://ko.wikipedia.org/wiki/%EC%82%AC%EC%9D%B4%ED%8A%B8_%EA%B0%84_%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8C%85">위키</a></p>
<blockquote>
<p>사이트 간 스크립팅(또는 크로스 사이트 스크립팅, 영문 명칭 cross-site scripting, 영문 약어 XSS)은 웹 애플리케이션에서 많이 나타나는 취약점의 하나로 <strong>웹사이트 관리자가 아닌 이가 웹 페이지에 악성 스크립트를 삽입할 수 있는 취약점이다. 주로 여러 사용자가 보게 되는 전자 게시판에 악성 스크립트가 담긴 글을 올리는 형태로 이루어진다.</strong> 이 취약점은 웹 애플리케이션이 사용자로부터 입력 받은 값을 제대로 검사하지 않고 사용할 경우 나타난다. 이 취약점으로 해커가 사용자의 정보(쿠키, 세션 등)를 탈취하거나, 자동으로 비정상적인 기능을 수행하게 할 수 있다. 주로 다른 웹사이트와 정보를 교환하는 식으로 작동하므로 사이트 간 스크립팅이라고 한다.</p>
</blockquote>
<p>게시판 등 자료를 올릴 수 있는 페이지에 악성 스크립트를 심는 경우이다.</p>
<p>보통 필터에서 스크립트 패턴등을 제거함으로써 방지할 수 있다.</p>
<h3 id="csrfxsrf-cross-site-request-forgery"><a class="toclink" href="../../../../2019/09/23/xss-csrfxsrf-same-origin-policy-cors/#csrfxsrf-cross-site-request-forgery">CSRF/XSRF (Cross-Site Request Forgery)</a></h3>
<p><a href="https://ko.wikipedia.org/wiki/사이트_간_요청_위조">위키</a></p>
<blockquote>
<p>사이트 간 요청 위조(또는 크로스 사이트 요청 위조, 영어: Cross-site request forgery, CSRF, XSRF)는 웹사이트 취약점 공격의 하나로, 사용자가 자신의 의지와는 무관하게 공격자가 의도한 행위(수정, 삭제, 등록 등)를 특정 웹사이트에 요청하게 하는 공격을 말한다.</p>
<p>유명 경매 사이트인 옥션에서 발생한 개인정보 유출 사건에서 사용된 공격 방식 중 하나다.</p>
<p>사이트 간 스크립팅(XSS)을 이용한 공격이 사용자가 특정 웹사이트를 신용하는 점을 노린 것이라면, 사이트간 요청 위조는 특정 웹사이트가 사용자의 웹 브라우저를 신용하는 상태를 노린 것이다. 일단 사용자가 웹사이트에 로그인한 상태에서 사이트간 요청 위조 공격 코드가 삽입된 페이지를 열면, 공격 대상이 되는 웹사이트는 위조된 공격 명령이 믿을 수 있는 사용자로부터 발송된 것으로 판단하게 되어 공격에 노출된다.</p>
</blockquote>
<p><strong>정상적인 사용자가 로그인 한 뒤</strong>, 악의적인 사용자로 부터 전달 받은</p>
<pre><code class="language-html">&lt;img src= &quot;https://travel.service.com/travel_update?.src=Korea&amp;.dst=Hell&quot;&gt;
</code></pre>
<p>태그가 있는 페이지를 열게 되면 악의적인 사용자의 요청을 서버는 정상적인 사용자의 요청으로 판단하게 됨.</p>
<p><code>Referrer</code> 검증과 <code>Security Token</code> 사용으로 방지할 수 있다.</p>
<h2 id="same-origin-policy"><a class="toclink" href="../../../../2019/09/23/xss-csrfxsrf-same-origin-policy-cors/#same-origin-policy">Same-Origin Policy</a></h2>
<p><code>javascript</code> 는 다른 페이지로 접근할때 Same-Origin 의 페이지만 접근이 가능했다. (다른 도메인 서버에 ajax 요청을 보내지 못함)<br />
이를 우회하거나
- <code>jsonp</code> 방식
- browser 기동 옵션
- browser 플러그인 설치</p>
<p>표준스펙에 맞춰서 접근을 할 수 있다.
- CORS (아래)</p>
<h2 id="cross-origin-resource-sharing-cors"><a class="toclink" href="../../../../2019/09/23/xss-csrfxsrf-same-origin-policy-cors/#cross-origin-resource-sharing-cors">Cross-Origin Resource Sharing (CORS)</a></h2>
<p>Cross-Site Request 를 가능하게 한다.
- Simple Request
- Preflight Request
- Credential Request
- Non-Credential Request</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-09-19 00:00:00+00:00">September 19, 2019</time></li>
        
        
          
          <li class="md-meta__item">
            
              1 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="first-class-citizen"><a class="toclink" href="../../../../2019/09/19/%EC%9D%BC%EA%B8%89%EA%B0%9D%EC%B2%B4first-class-citizen%EA%B0%80-%EB%AD%90%EC%A7%80/">일급객체(First class citizen)가 뭐지?</a></h2>
<p>1급 객체란?
아래 3 가지조건을 충족한다면 1급 객체라고 할수 있습니다.</p>
<ol>
<li>변수나 데이타에 할당 할 수 있어야 한다.</li>
<li>객체의 인자로 넘길 수 있어야 한다.</li>
<li>객체의 리턴값으로 리턴 할수 있어야 한다.</li>
</ol>
<p><code>javascript</code> 에서는 함수가 1급 객체지만, <code>java</code> 에선 그렇지 않다.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-09-17 00:00:00+00:00">September 17, 2019</time></li>
        
        
          
          <li class="md-meta__item">
            
              1 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="docker-apt-udpate"><a class="toclink" href="../../../../2019/09/17/docker-%EC%97%90%EC%84%9C-apt-udpate-%EC%9D%B4%ED%9B%84-%EB%A9%88%EC%B6%A4/">docker 에서 apt udpate 이후 멈춤</a></h2>
<h4 id="ubuntu-image-base-dockerfile-run-apt-update"><a class="toclink" href="../../../../2019/09/17/docker-%EC%97%90%EC%84%9C-apt-udpate-%EC%9D%B4%ED%9B%84-%EB%A9%88%EC%B6%A4/#ubuntu-image-base-dockerfile-run-apt-update">ubuntu image base 에서 dockerfile 에 RUN apt update 사용시</a></h4>
<p><a href="https://stackoverflow.com/questions/27273412/cannot-install-packages-inside-docker-ubuntu-image">stackoverflow 답변</a></p>
<pre><code class="language-shell">#1. apt udpate 이후 멈춰있음
RUN apt update
RUN apt intall -y wget

#2. 실행됨
RUN apt update &amp;&amp; apt install -y wget
</code></pre>
<blockquote>
<p>빌어먹을거 뭔차이지..</p>
</blockquote>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-09-17 00:00:00+00:00">September 17, 2019</time></li>
        
        
          
          <li class="md-meta__item">
            
              1 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="vault-with-docker"><a class="toclink" href="../../../../2019/09/17/vault-with-docker/">Vault with docker</a></h2>
<h3 id="docker-vault"><a class="toclink" href="../../../../2019/09/17/vault-with-docker/#docker-vault">docker vault 를 빠르게 실행해보자</a></h3>
<p><code>--cap-add=IPC_LOCK</code></p>
<blockquote>
<p>Memory Locking and 'setcap'
The container will attempt to lock memory to prevent sensitive values from being swapped to disk and as a result must have --cap-add=IPC_LOCK provided to docker run. Since the Vault binary runs as a non-root user, setcap is used to give the binary the ability to lock memory. With some Docker storage plugins in some distributions this call will not work correctly; it seems to fail most often with AUFS. The memory locking behavior can be disabled by setting the SKIP_SETCAP environment variable to any non-empty value.</p>
</blockquote>
<p><code>-e 'VAULT_ADDR=http://127.0.0.1:8200'</code></p>
<blockquote>
<p>기본적으로 vault client 에서 https 를 사용하고 있기 때문에, http 를 사용하려면 vault 어쩌고 명령어를 할때마다 --address=https://127.0.0.1:8200 을 같이 써야한다. 귀찮으니까 환경변수로 넣자.
환경변수가 없고 https 없이 (환경변수에서 tls_disable) 컨테이너를 기동하면 vault 명령어시 아래와 같은 오류가 나온다.
<code>Error checking seal status: Get https://127.0.0.1:8200/v1/sys/seal-status: http: server gave HTTP response to HTTPS client</code></p>
</blockquote>
<p><code>-v vaultdata:/vault/file:z</code></p>
<blockquote>
<p>vaultdata 라는 docker volume 이 미리 준비되어있어야한다. 마지막에 z 옵션은 SELinux 가 활성화 되어있으면 사용해야한다.</p>
</blockquote>
<pre><code class="language-shell">$ docker volume create vaultdata

$ docker run \
  -d \
  -p 8200:8200 \
  --name=dev-vault \
  --cap-add=IPC_LOCK \
  --restart=always \
  -e 'VAULT_LOCAL_CONFIG={&quot;storage&quot;: {&quot;file&quot;: {&quot;path&quot;: &quot;/vault/file&quot;}}, &quot;listener&quot;: {&quot;tcp&quot;: { &quot;address&quot;: &quot;0.0.0.0:8200&quot;, &quot;tls_disable&quot;: &quot;true&quot;}}, &quot;ui&quot;: &quot;true&quot;, &quot;default_lease_ttl&quot;: &quot;168h&quot;, &quot;max_lease_ttl&quot;: &quot;720h&quot;}' \
  -e 'VAULT_ADDR=http://127.0.0.1:8200' \
  -v vaultdata:/vault/file:z \
  docker.io/vault:1.4.0 server
</code></pre>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-09-17 00:00:00+00:00">September 17, 2019</time></li>
        
        
          
          <li class="md-meta__item">
            
              2 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="promise"><a class="toclink" href="../../../../2019/09/17/promise-%EC%9D%98-%EC%83%81%ED%83%9C%EB%A5%BC-%EB%B3%B4%EB%A0%A4%EB%A9%B4/">Promise 의 상태를 보려면</a></h2>
<p>관련 포스트
- <a href="{{ site.url}}/javascript-promise">Promise 가 뭐지</a></p>
<blockquote>
<p>내마음대로 지껄일거야 틀려도몰라 흥흥</p>
</blockquote>
<p>javascript Promise 객체에는 세가지 상태가 있다.
- pending
- resolved
- rejected</p>
<p>명칭만 봐도 직관적으로 알겠다.</p>
<blockquote>
<p>browser console 창에서는 resolved 로 되어있는데 fulfilled 가 맞는지 잘 모르겠다. 아무튼.</p>
</blockquote>
<p>아무튼. 이 상태를 직접 읽어올 방법이 없는 듯 한데..</p>
<p><a href="https://ourcodeworld.com/articles/read/317/how-to-check-if-a-javascript-promise-has-been-fulfilled-rejected-or-resolved">출처</a></p>
<pre><code class="language-javascript">/**
 * This function allow you to modify a JS Promise by adding some status properties.
 * Based on: http://stackoverflow.com/questions/21485545/is-there-a-way-to-tell-if-an-es6-promise-is-fulfilled-rejected-resolved
 * But modified according to the specs of promises : https://promisesaplus.com/
 */
function MakeQuerablePromise(promise) {
    // Don't modify any promise that has been already modified.
    if (promise.isResolved) return promise;

    // Set initial state
    var isPending = true;
    var isRejected = false;
    var isFulfilled = false;

    // Observe the promise, saving the fulfillment in a closure scope.
    var result = promise.then(
        function(v) {
            isFulfilled = true;
            isPending = false;
            return v;
        },
        function(e) {
            isRejected = true;
            isPending = false;
            throw e;
        }
    );

    result.isFulfilled = function() { return isFulfilled; };
    result.isPending = function() { return isPending; };
    result.isRejected = function() { return isRejected; };
    return result;
}
</code></pre>
<p>사용법은 아래와 같다..</p>
<blockquote>
<p>그냥 복붙한 것 같아서 꼐림칙하지만.. ㅠㅠ 기록이니깐..</p>
</blockquote>
<pre><code class="language-javascript">// Your promise won't cast the .then function but the returned by MakeQuerablePromise
var originalPromise = new Promise(function(resolve,reject){
    setTimeout(function(){
        resolve(&quot;Yeah !&quot;);
    },10000);
});

var myPromise = MakeQuerablePromise(originalPromise);

console.log(&quot;Initial fulfilled:&quot;, myPromise.isFulfilled());//false
console.log(&quot;Initial rejected:&quot;, myPromise.isRejected());//false
console.log(&quot;Initial pending:&quot;, myPromise.isPending());//true

myPromise.then(function(data){
    console.log(data); // &quot;Yeah !&quot;
    console.log(&quot;Final fulfilled:&quot;, myPromise.isFulfilled());//true
    console.log(&quot;Final rejected:&quot;, myPromise.isRejected());//false
    console.log(&quot;Final pending:&quot;, myPromise.isPending());//false
});
</code></pre>
<p>간단한 <code>wrapping function</code> 과 <code>closure scope</code> 를 이용하여 상태를 알 수 있게 되었다!!</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-09-17 00:00:00+00:00">September 17, 2019</time></li>
        
        
          
          <li class="md-meta__item">
            
              9 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="common-command-on-linuxcentos"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/">Common Command on Linux(CentOS)</a></h2>
<h3 id="_1"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#_1">시스템 관련</a></h3>
<pre><code class="language-shell">echo $USER #echo currernt user

# os info
uname -a
# 위에 것으로 모를때. 대체로 모름
cat /etc/*release*
cat /etc/os-release

#os kernal version
uname -r

#os bit 1
uname -m

#os bit 2
getconf LONG_BIT

#os bit 3
arch

#cpu info
lscpu

#cpu count
nproc

#memory info
free

#--human-readable
free -h

#echo current path
pwd

history #사용한 명령어 히스토리
![line number] #히스토리의 해당 라인을 재실행

file -bi [CHECK_FILE_NAME] #파일의 캐릭터셋을 확인한다
#-b --brief                do not prepend filenames to output lines
#-i, --mime                 output MIME type strings (--mime-type and --mime-encoding)

ls #디렉토리 내용 확인

lscpu # cpu info
ulimit -n # open file number per core
</code></pre>
<h3 id="systemctl"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#systemctl">systemctl</a></h3>
<pre><code class="language-shell">systemctl start SERVICE_NAME.service
systemctl restart SERVICE_NAME.service
systemctl stop SERVICE_NAME.service
systemctl try-restart SERVICE_NAME.service #restart service when service is active
systemctl reload SERVICE_NAME.service
systemctl status SERVICE_NAME.service
systemctl cat SERVICE_NAME.service #check script?
# service list 확인
systemctl list-units
# service 자동 시작 확인/설정/해제
systemctl is-enabled SERVICE_NAME.service
systemctl enable SERVICE_NAME.service
systemctl disable SERVICE_NAME.service

</code></pre>
<h4 id="service"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#service">service 만들기</a></h4>
<pre><code class="language-shell">cd /etc/systemd/system
sudo vim &lt;YOUR-SERVICE-NAME&gt;.service
---
[Unit]
Description=&lt;YOUR-SERVICE-DESCRIPTION&gt;

[Service]
Type=simple
User=&lt;USER-NAME&gt;
Group=&lt;USER-GROUP&gt;
ExecStart=&lt;YOUR-SERVICE-EXECUTION-COMMAND&gt;
# ex : ExecStart=/bin/bash /home/irteam/actions-runner/run.sh
Restart=on-failure

[Install]
WantedBy=multi-user.target
---
sudo systemctl start &lt;YOUR-SERVICE-NAME&gt;
systemctl status &lt;YOUR-SERVICE-NAME&gt;
sudo systemctl enable &lt;YOUR-SERVICE-NAME&gt;.service
</code></pre>
<h3 id="user"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#user">User</a></h3>
<pre><code class="language-shell">cat /etc/passwd #check user
cat /etc/shadow #check user password
cat /etc/group #check group

su - [USER ID] #change user

useradd [OPTION] [USER ID]
#-m : make home dir
#-g : set group
passwd [USER ID] #set password
usermod [OPTION] [USER ID]
#-c [COMMENT] : add comment
#-g [GROUP NAME]: change primary group for user
#-G [GROUP NAME] : supplementary


groups [USER ID] #check user group
groupadd [GROUP NAME] #add group
groupdel [GROUP NAME] #delete group

gpasswd [GROUP NAME] #set group password
gpasswd -r [GROUP NAME] #remove group password
gpasswd -a [USER ID] [GROUP NAME] #add user to group

chown [OPTION] [OWNER:GROUP] [FILE]
chmod [OPTION] [PERMISSION] [FILE]
#-c : show change file
#-R : recursive work
# u = owner
# g = group
# o = other
# +, -, =
# r, w, x
chmod u=rwx,g=rx,o=rx ./token.txt
</code></pre>
<h3 id="process"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#process">process</a></h3>
<pre><code class="language-shell">$ ps -ef | grep nginx
</code></pre>
<h3 id="port"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#port">port</a></h3>
<h4 id="netstat"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#netstat">netstat</a></h4>
<pre><code class="language-shell"># options
# -l    Listening 중인 socket을 표시합니다.
# -p    socket을 사용하는 pid와 program 이름을 보여줍니다.
# -n    주소등을 number로 표시합니다(ex localhost를 127.0.0.1 로 표현)
# -i    interface의 정보를 보여줍니다.
# -t    tcp 사용 socket을 보여줍니다.
# -u    udp 사용 socket을 보여줍니다.
# -r    routing table을 보여줍니다.
# -a    listening과 non-listening 상태 모두를 보여줍니다.
# -c    매 초마다 명령을 계속적으로 실행합니다.
$ netstat -tunlp
</code></pre>
<p>mac os 에서는 좀 다르다</p>
<pre><code class="language-shell"># 열린 포트 확인
$ sudo  

# 열린 포트의 PID 확인
$ sudo lsof -i :3000
</code></pre>
<h4 id="firewall"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#firewall">firewall 방화벽</a></h4>
<ul>
<li>centos6 이하에서는 <code>iptables</code> 사용</li>
<li>centos7 에서는 <code>firewall-cmd</code> 사용</li>
</ul>
<h3 id="_2"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#_2">환경변수</a></h3>
<pre><code class="language-shell">env
export
</code></pre>
<h3 id="date"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#date">date</a></h3>
<ul>
<li>format 은 같으나, date add/substract 옵션이 linux/macos 다르다</li>
</ul>
<pre><code class="language-shell"># %Y : year
# %m : month
# %d : day
# %H : 24h
# %I : 12h
# %M : minute
# %S : second
# %p : AM/PM
# %s : timestamp

# linux
$ date
$ date -d '9 hour' &quot;+%Y-%m-%dT%H:%M:%S&quot;
$ date -d '9 hour ago' &quot;+%Y-%m-%dT%H:%M:%S&quot;
## milli seconds
$ date &quot;+%s&quot;

# mac
$ date
$ date -v-9H &quot;+%Y-%m-%dT%H:%M:%S&quot;

</code></pre>
<h3 id="_3"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#_3">압축</a></h3>
<pre><code class="language-shell">tar -cvzf [COMPRESSED NAME].tar.gz [COMPRESSING TARGET]
tar -xvzf [UNCOMPRESSING TARGET]
#v : 묶음/해제 과정을 화면에 표시
#c : 파일을 묶음
#x : 묶음을 해제
#z : gunzip을 사용
#f : 파일 이름을 지정
#p : 권한(permission)을 원본과 동일하게 유지

ln -s [SYMBOLIC LINK TARGET] [SYMBOLIC LINK NAME]

# 디렉토리와 하위 디렉토리 사이즈
du -h --apparent-size [TARGET LOCATION:DEFAULT .]
</code></pre>
<h4 id="alias"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#alias">자주쓰는 alias</a></h4>
<blockquote>
<p>alias 설정을 위해 <code>.bashrc</code> 수정</p>
</blockquote>
<pre><code class="language-shell">vi ~/.bashrc #modify .bashrc file
</code></pre>
<blockquote>
<p>alias 내용</p>
</blockquote>
<pre><code class="language-shell">alias cp='cp -i'
alias mv='mv -i'

alias compress='tar -cvzf'
alias uncompress='tar -xvzf'

alias start='systemctl start'
alias stop='systemctl stop'
alias status='systemctl status'
alias restart='systemctl restart'
alias reload='systemctl reload'

#for docker
alias dps='docker ps'
alias dimg='docker images'

#for public web server
alias connect_private_server='ssh -i /root/herdin-aws-study-copy.pem'
alias vim_nginx_conf='vim /etc/nginx/nginx.conf'
alias cd_nginx_conf='cd /etc/nginx'
alias cd_nginx_home='cd /usr/share/nginx/html'

#for private was server
alias cd_tomcat_home='cd /usr/share/tomcat'
</code></pre>
<blockquote>
<p>alias 설정 적용</p>
</blockquote>
<pre><code class="language-shell">source ~/.bashrc #modified .bashrc file apply
</code></pre>
<blockquote>
<p>alias 해제</p>
</blockquote>
<pre><code class="language-shell">unalias vim_nginx_conf
</code></pre>
<h3 id="_4"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#_4">명령어의 결과를 명령어안에 넣기</a></h3>
<p>백팃 이나 <code>"$()"</code> 를 사용하면된다</p>
<pre><code class="language-shell">$ echo `cat ~/deleteme/test.conf`
hello, config
$ echo &quot;$(cat ~/deleteme/test.conf)&quot;
hello, config
</code></pre>
<h3 id="set"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#set">set</a></h3>
<ul>
<li>-o pipefail 파이프 사용시 오류 코드(non-zero exit code) 승계</li>
<li>-e 오류가 발생하면 중단</li>
<li>+e 오류가 발생해도 진행</li>
<li>-u 설정되지 않은 변수를 사용하려고 하면 종료</li>
<li>-x 실행되는 명령어와 인수들을 출력</li>
</ul>
<h4 id="set-o-pipefail"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#set-o-pipefail">set -o pipefail</a></h4>
<p>exit code 승계</p>
<pre><code class="language-shell"># 아래와 같은 test1.sh 을 실행한다고 하면,
# /non/exsitent/file 가 없기 때문에 exit code 가 0 이 아니게되지만, 파이프 연산자에 의해 wc 가 정상 수행되면서 echo $? 에서 0 이 출력된다.
cat /non/exsitent/file | wc
echo $?

# 하지만 아래와 같이 set -o pipefail 를 넣으면, exit code 가 승계되어 echo $? 에서 1 이 출력된다.
set -o pipefail
cat /non/exsitent/file | wc
echo $?
</code></pre>
<h4 id="set-e"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#set-e">set -e</a></h4>
<p>오류가 발생하면 중단</p>
<pre><code class="language-shell"># 아래와 같은 test1.sh 를 실행하게되면, 중간에 오류가 나지만 hello, world 가 모두 출력 실행된다.
echo hello
cat asdfasdfasdf
echo world

# 하지만, set -e 를 함께 실행하면, hello 이후 오류가 나서 실행을 멈춘다.
set -e
echo hello
cat asdfasdfasdf
echo world
</code></pre>
<h3 id="process_1"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#process_1">Process.</a></h3>
<pre><code class="language-shell">ps #process show
#-e : show all
#-f : full format
#-l : long format
#-p : specific process
#-u : specific user process

kill #process kill
#-l : show SIGNAL list
1) SIGHUP       2) SIGINT       3) SIGQUIT      4) SIGILL       5) SIGTRAP
6) SIGABRT      7) SIGBUS       8) SIGFPE       9) SIGKILL     10) SIGUSR1
11) SIGSEGV     12) SIGUSR2     13) SIGPIPE     14) SIGALRM     15) SIGTERM
16) SIGSTKFLT   17) SIGCHLD     18) SIGCONT     19) SIGSTOP     20) SIGTSTP
21) SIGTTIN     22) SIGTTOU     23) SIGURG      24) SIGXCPU     25) SIGXFSZ
26) SIGVTALRM   27) SIGPROF     28) SIGWINCH    29) SIGIO       30) SIGPWR
31) SIGSYS      34) SIGRTMIN    35) SIGRTMIN+1  36) SIGRTMIN+2  37) SIGRTMIN+3
38) SIGRTMIN+4  39) SIGRTMIN+5  40) SIGRTMIN+6  41) SIGRTMIN+7  42) SIGRTMIN+8
43) SIGRTMIN+9  44) SIGRTMIN+10 45) SIGRTMIN+11 46) SIGRTMIN+12 47) SIGRTMIN+13
48) SIGRTMIN+14 49) SIGRTMIN+15 50) SIGRTMAX-14 51) SIGRTMAX-13 52) SIGRTMAX-12
53) SIGRTMAX-11 54) SIGRTMAX-10 55) SIGRTMAX-9  56) SIGRTMAX-8  57) SIGRTMAX-7
58) SIGRTMAX-6  59) SIGRTMAX-5  60) SIGRTMAX-4  61) SIGRTMAX-3  62) SIGRTMAX-2
63) SIGRTMAX-1  64) SIGRTMAX
#ex)
kill -SIGNAL PROCESS_ID
kill -2 123
kill -INT 123 #SIGINT - SIG
</code></pre>
<p>kill -9 ${PID} 를 사용하면 안되는 이유.</p>
<p>개발자가 시그널핸들러를 작성했는데도 불구하고 <code>SIGKILL</code>(9), <code>SIGSTOP</code>(19) 은 핸들러를 등록할 수 없는 시그널이기 때문에 사용을 지양해야 한다.</p>
<p>시그널 핸들러가 등록되지 않았을 때의 커널에 정의된 기본 행동 <a href="https://www.lesstif.com/pages/viewpage.action?pageId=12943674">출처</a></p>
<div id="pureTableHere"></div>
<script>
  util().genPureTable(
    'pureTableHere',
    ['SIGNAL', '기본 행동'],
    [
      ['TERM', '시그널을 수신한 프로세스 종료'],
      ['IGN', '시그널 무시'],
      ['CORE', '시그널을 수신한 프로세스를 종료하면서 코어 덤프(core dump) 파일 생성'],
      ['STOP', '시그널을 수신한 프로세스 정지'],
      ['CONT', '중지된 프로세스 재시작'],
    ]
  );
</script>

<h3 id="ls"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#ls">ls</a></h3>
<p>디렉토리 목록 출력</p>
<pre><code class="language-shell"># 시간순 정렬, 오름차순
$ ls -trl 
$ ls -trlh
# 파일크기 정렬, 오름차순
$ ls -Srlh
</code></pre>
<h3 id="df-disk-free"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#df-disk-free">df : disk free</a></h3>
<pre><code class="language-shell">#--human-readable
$ df -h
#--inodes
$ df -i
#--block-size=1K
$ df -k
</code></pre>
<h3 id="du-disk-usage"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#du-disk-usage">du : disk usage</a></h3>
<pre><code class="language-shell">$ du -sh *
$ du --summarize --human-readable *
# 해당 위치에서 폴더별 크기를 보여준다
$ du -smh * | sort -rh 
$ du -smh {location}
</code></pre>
<ul>
<li><a href="https://goateedev.tistory.com/181">참고</a></li>
</ul>
<h3 id="file-shrink"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#file-shrink">file shrink</a></h3>
<p>disk 가 full 났을때 파일 처리</p>
<pre><code class="language-shell"># 파일에 권한이 있다면 바로 실행
tail -n 100 access.log &gt; access.log
# 파일에 권한이 없는 경우
sudo bash -c &quot;tail -n 100 access.log &gt; access.log&quot;

# 또는 truncate 사용
</code></pre>
<h3 id="ln"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#ln">ln</a></h3>
<pre><code class="language-shell">$ ln -sf

</code></pre>
<ul>
<li><a href="https://jhnyang.tistory.com/269">temp</a></li>
</ul>
<h3 id="grep"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#grep">grep</a></h3>
<pre><code class="language-shell">$ grep [옵션][패턴][파일명]
</code></pre>
<h3 id="find"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#find"><a href="https://recipes4dev.tistory.com/156">find</a></a></h3>
<pre><code class="language-shell"># 파일명으로 찾을 경우
# find ${find-location} -name &quot;${target-file-name}&quot;
$ find / -name hello
</code></pre>
<h3 id="wc-word-count"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#wc-word-count">wc - word count?</a></h3>
<pre><code class="language-shell"># -l : lines
# -c : bytes
# -m : characters
# -w : word
$ wc -l
$ echo &quot;hello&quot; | wc -m
6
</code></pre>
<h3 id="cut"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#cut">cut</a></h3>
<p>문자열 자를때 사용</p>
<pre><code class="language-shell"># -b : byte
# -c : character
# -f : field
# -d : delimeter (default tab)
$ echo &quot;hello&quot; | cut -c1-4
$ echo &quot;hello\tworld&quot; | cut -f 1
</code></pre>
<h4 id="shellscript-while"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#shellscript-while">shellscript while</a></h4>
<p>docker stack deploy 이후, service 가 뜨는지 확인하기 위해 계속 치는게 귀찮아서 사용했다.</p>
<pre><code class="language-shell">$ while true
$ do
$ docker service ls
$ sleep 2
$ done
</code></pre>
<h4 id="bash-ps1-gen"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#bash-ps1-gen">Bash PS1 gen</a></h4>
<p><a href="http://ezprompt.net/">Bash Prompt gen</a></p>
<h3 id="base64"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#base64">base64</a></h3>
<ul>
<li><code>-d, --decode</code></li>
<li><code>-i, --input</code> (default)</li>
</ul>
<pre><code class="language-shell"># encode 했다가 decode 하기
$ echo &quot;hello world, epubaal&quot; | base64 | base64 -d
hello world, epubaal

# 파일을 사용하기
$ echo &quot;hello world, epubaal, in file&quot; &gt; test.txt
# 파일 내용 확인
$ cat test.txt                                   
hello world, epubaal, in file

# 파일내용 encode 해서 다른 파일에 넣기
$ base64 test.txt &gt; test-encode.txt
# 파일 내용 확인
$ cat test-encode.txt 
aGVsbG8gd29ybGQsIGVwdWJhYWwsIGluIGZpbGUK

# 파일내용 decode 해서 다른 파일에 넣기
$ base64 -d test-encode.txt &gt; test-decode.txt
# 파일 내용 확인
$ cat test-decode.txt
hello world, epubaal, in file
</code></pre>
<h3 id="more"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#more">more</a></h3>
<pre><code class="language-shell">$ more &lt;FILE_NAME&gt;
</code></pre>
<ul>
<li>화면 가득히 파일내용을 출력해준다</li>
<li><code>space bar</code> 를 누르면 파일에서 한줄씩 내려간다.</li>
<li><code>enter</code> 를 누르면 화면에서 한줄씩 내려간다.</li>
<li>현재보이는 내용이 전체 파일에서 몇 % 를 차지하는지 알려준다.</li>
<li><code>f</code> 를 누르면 forward 1페이지만큼 다음으로 간다</li>
<li><code>b</code> 를 누르면 backward 1페이지만큼 이전으로 간다</li>
</ul>
<h3 id="less"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#less">less</a></h3>
<p><code>more</code> 같은데 페이지단위로 볼 수 있고, 끝에서부터도 볼 수 있다.</p>
<pre><code class="language-shell">$ less &lt;FILE_NAME&gt;
$ less -N &lt;FILE_NAME&gt; # show line number

# 화살표키 위아래로 한줄씩이동
# space, f 로 한페이지 아래로 이동
# b 으로 한페이지 위로 이동
# G 로 끝으로 이동
# more 와 유사하게 `/` 로 검색
# q 로 종료
</code></pre>
<h3 id="tr"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#tr">tr</a></h3>
<ul>
<li>입력받은문자에서 특정문자를 자르거나 변경할때</li>
</ul>
<h3 id="sort"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#sort">sort</a></h3>
<ul>
<li>입력받은 라인을 정렬</li>
</ul>
<h3 id="uniq"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#uniq">uniq</a></h3>
<ul>
<li>입력받은 라인에서 중복을 제거</li>
<li>곁에있는 라인에서 중복을 제거하므로, sort 다음에 쓰인다.</li>
</ul>
<h3 id="comm"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#comm">comm</a></h3>
<p>두 파일을 비교한다</p>
<pre><code class="language-shell">$ comm [option] [file1] [file2]
# [option]
# -1 두개를 비교하여 파일 1에만 있는 것은 출력하지 않음
# -2 두개를 비교하여 파일 2에만 있는 것은 출력하지 않음
# -3 두개를 비교하여 파일 1과 파일 2에 모두 존재하는 라인은 출력하지 않음

</code></pre>
<h3 id="scp-ssh-secure-copy"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#scp-ssh-secure-copy">scp : ssh 기반의 secure copy 를 수행. 원격파일카피.</a></h3>
<pre><code class="language-shell"># r option for directory
scp -r &lt;local-file-location&gt; &lt;remote-id&gt;@&lt;remote-host&gt;:&lt;remote-file-location&gt;
scp -r &lt;remote-id&gt;@&lt;remote-host&gt;:&lt;remote-file-location&gt; &lt;local-file-location&gt;
scp -r epu@file.anmani.link:/home/remote-epu/tmp /Users/user/Downloads/tmp
</code></pre>
<h3 id="crontab"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#crontab">crontab</a></h3>
<pre><code class="language-shell"># 확인
crontab -l
# 편집
crontab -e
# 삭제
crontab -r
# *        *　　　   　*　　 　　　*　 　 　　*
# 분(0-59)　시간(0-23) 일(1-31) 월(1-12) 요일(0-7,[0,7:일요일])
</code></pre>
<ul>
<li><a href="https://jdm.kr/blog/2">참고</a></li>
</ul>
<h3 id="selinux"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#selinux">SELinux</a></h3>
<p><a href="{{ site.url }}/2019/08/27/selinux">SELinux 란?</a></p>
<pre><code class="language-shell">sestatus #selinux status
getenforce #selinux mode check
setenforce 0 #selinux mode set Permissive=0 [로그만남김], Enforcing=1 [selinux 적용]
tail -f /var/log/audit/audit.log #log

matchpathcon [FILE PATH] #check security context
chcon [OPTION] [CONTEXT FILE] #change context
#-t : type
#-R : recursive
</code></pre>
<h3 id="package-management"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#package-management">package management</a></h3>
<pre><code class="language-shell"># RHEL/CentOS
$ yum install package_name
# Ubuntu
$ apt install package_name
# Alpine
$ apk add package_name
# Debian
$ apk install package_name
# apt update &amp;&amp; apt install -y procps
# apt update &amp;&amp; apt install -y vim
# apt update &amp;&amp; apt install -y sudo
</code></pre>
<h3 id="yum"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#yum">yum</a></h3>
<p>레드햇 계열의 리눅스 배포판에서 사용하는 프로그램(패키지) 설치 관리 도구</p>
<h4 id="yum-repository"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#yum-repository">yum repository 활성화/비활성화</a></h4>
<pre><code class="language-shell"># base repository 의 상태를 확인
$ yum repolist base -v

# repo list 의 상태가 저장된 파일들이 있는곳
$ cd /etc/yum.repos.d

# 안에서 설정파일들의 enabled=0 를 변경한다. (0 비활성화, 1 활성화)
</code></pre>
<h3 id="traceroute"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#traceroute">traceroute</a></h3>
<pre><code class="language-shell">$ traceroute www.naver.com
traceroute: Warning: www.naver.com has multiple addresses; using 223.130.195.200
traceroute to www.naver.com.nheos.com (223.130.195.200), 64 hops max, 52 byte packets
 1  10.200.200.200 (10.200.200.200)  20.043 ms  4.234 ms  4.871 ms
 2  10.104.248.45 (10.104.248.45)  20.214 ms  4.501 ms  4.504 ms
 3  10.104.248.5 (10.104.248.5)  21.917 ms  5.678 ms  5.257 ms
 4  10.104.245.26 (10.104.245.26)  20.284 ms  5.247 ms
    10.104.245.22 (10.104.245.22)  19.672 ms
 5  10.104.240.49 (10.104.240.49)  20.054 ms
    10.104.241.47 (10.104.241.47)  20.204 ms
    10.104.241.49 (10.104.241.49)  23.500 ms
 6  223.130.195.200 (223.130.195.200)  19.518 ms  4.366 ms  4.473 ms
</code></pre>
<h3 id="ftpsftp"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#ftpsftp">ftp/sftp</a></h3>
<pre><code class="language-shell"># ftp ${ip}
# ftp ${ip} ${port}
$ ftp 1.22.333.444 8888


# sftp -P ${port} ${id}@${ip}
$ sftp -P 8888 id@1.22.333.444

$ sftp -P ${PORT_NUMBER} -oIdentityFile=/path/to/private/key user@hostname

# 접속 후
ls
pwd
get &lt;filename&gt;
</code></pre>
<h3 id="jdk"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#jdk">jdk 관련..</a></h3>
<h4 id="jvm-javaiotmpdir"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#jvm-javaiotmpdir">jvm 에서 사용하는 <code>java.io.tmpdir</code> 가 어딘지 확인해보고싶었다.</a></h4>
<pre><code class="language-shell"># 먼저 java 프로그램을 찾아서
$ ps -ef | grep java
# pid 를 jino 에 넣어준다
# jinfo ${pid}
$ jinfo 12345

Java System Properties:
#Fri Feb 04 15:55:52 KST 2022
awt.toolkit=sun.lwawt.macosx.LWCToolkit
java.specification.version=11
kotlinx.coroutines.debug=off
sun.cpu.isalist=
sun.jnu.encoding=UTF-8
sun.arch.data.model=64
idea.fatal.error.notification=disabled
sun.font.fontmanager=sun.font.CFontManager
pty4j.preferred.native.folder=/Applications/IntelliJ IDEA.app/Contents/lib/pty4j-native
java.vendor.url=https\://openjdk.java.net/
apple.awt.fileDialogForDirectories=true
sun.java2d.uiScale.enabled=true
sun.io.useCanonCaches=false
jna.tmpdir=/Users/user/Library/Caches/JetBrains/IntelliJIdea2021.2/tmp
sun.boot.library.path=/Applications/IntelliJ IDEA.app/Contents/jbr/Contents/Home/lib
jdk.debug=release
sun.awt.exception.handler=com.intellij.openapi.application.impl.AWTExceptionHandler
com.apple.mrj.application.live-resize=false
java.specification.vendor=Oracle Corporation
java.version.date=2021-04-20
java.home=/Applications/IntelliJ IDEA.app/Contents/jbr/Contents/Home
file.separator=/
java.vm.compressedOopsMode=Zero based
line.separator=\n
java.specification.name=Java Platform API Specification
java.vm.specification.vendor=Oracle Corporation
jdk.attach.allowAttachSelf=true
idea.home.path=/Applications/IntelliJ IDEA.app/Contents
pty4j.tmpdir=/Users/user/Library/Caches/JetBrains/IntelliJIdea2021.2/tmp
sun.management.compiler=HotSpot 64-Bit Tiered Compilers
java.runtime.version=11.0.11+9-b1504.16
apple.awt.fullscreencapturealldisplays=false
user.name=user
javax.swing.rebaseCssSizeMap=true
idea.paths.selector=IntelliJIdea2021.2
sun.java2d.pmoffscreen=false
sun.awt.noerasebackground=true
file.encoding=UTF-8
jnidispatch.path=/Users/user/Library/Caches/JetBrains/IntelliJIdea2021.2/tmp/jna7920715044168139379.tmp
idea.popup.weight=heavy
java.vendor.version=JBR-11.0.11.9-1504.16-jcef
jna.loaded=true
java.io.tmpdir=/var/folders/12/f2csmhbn7ll786vc8wvz26mw0000gn/T/
java.version=11.0.11
idea.xdebug.key=-Xdebug

</code></pre>
<p>찾았당 -&gt; java.io.tmpdir=/var/folders/12/f2csmhbn7ll786vc8wvz26mw0000gn/T/</p>
<h4 id="jar"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#jar">jar 파일 내용을 확인해 보고싶다</a></h4>
<pre><code class="language-shell">$ jar tf &lt;JAR FILE NAME&gt;
</code></pre>
<h3 id="openssl"><a class="toclink" href="../../../../2019/09/17/common-command-on-linuxcentos/#openssl">openssl</a></h3>
<pre><code class="language-shell"># host:port 로 유효기간 확인
openssl s_client -connect &lt;HOST&gt;:&lt;PORT&gt; -showcerts | openssl x509 -enddate
# 인증서 file 유효기간 확인
openssl x509 -in &lt;CERT-FILE&gt; -noout -dates
</code></pre>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-09-17 00:00:00+00:00">September 17, 2019</time></li>
        
        
          
          <li class="md-meta__item">
            
              6 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="vault"><a class="toclink" href="../../../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/">Vault 맛보기</a></h2>
<p><a href="https://www.vaultproject.io/docs/install/">공식 문서</a></p>
<h2 id="_1"><a class="toclink" href="../../../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#_1">설치부터 해보자</a></h2>
<h4 id="_2"><a class="toclink" href="../../../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#_2">다운을 받자</a></h4>
<p><code>/tools/vault</code> 폴더를 만들고 거기에 설치할 계획이다.<br />
<code>docker</code> 버전으로 기동을 한다고해도 <code>vault cli</code> 때문이라도 깔아놓자.</p>
<pre><code class="language-shell">#download vault 1.1.2
$ wget https://releases.hashicorp.com/vault/1.1.2/vault_1.1.2_linux_amd64.zip
$ mkdir /tools/vault
$ unzip vault_1.1.2_linux_amd64.zip -d /tools/vault
</code></pre>
<h4 id="_3"><a class="toclink" href="../../../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#_3">압축풀었으면 환경변수를 세팅하자.</a></h4>
<pre><code class="language-shell">#setting vault path
$ cd ~
$ vim .bashrc

#&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; editor start
export VAULT_HOME=/tools/vault
export PATH=${VAULT_HOME}:${PATH}
export VAULT_ADDR='http://127.0.0.1:8200'
export VAULT_ROOT_TOKEN=''
#&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; editor end

$ source .bashrc
</code></pre>
<h4 id="vault-cli"><a class="toclink" href="../../../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#vault-cli">설치가 잘되었는지 vault cli 를 사용해보자</a></h4>
<pre><code class="language-shell">#verifying the installation
$ vault
#set vault autocomplete to bash
$ vault -autocomplete-install
$ exec $SHELL
</code></pre>
<h4 id="_4"><a class="toclink" href="../../../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#_4">개발모드란게 있지만..</a></h4>
<pre><code class="language-shell">#run vault server dev mode
$ vault server -dev
</code></pre>
<blockquote>
<p>사용해본적은 없다.</p>
</blockquote>
<h4 id="_5"><a class="toclink" href="../../../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#_5">운영모드로 세팅해보자</a></h4>
<blockquote>
<p>config.hcl</p>
</blockquote>
<pre><code class="language-shell">storage &quot;file&quot; {
  path = &quot;/mnt/vault/data&quot;
}

listener &quot;tcp&quot; {
  address = &quot;0.0.0.0:8200&quot;
  tls_disable = false
}

ui = true
</code></pre>
<p><code>ui = true</code> 옵션을 넣었기 떄문에 <code>vault ui url = http://host.domain.name:8200/ui</code> 에 접속했을 경우 웹 페이지가 나와야한다.</p>
<h2 id="_6"><a class="toclink" href="../../../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#_6">세팅을 했으면 기동을 해보자</a></h2>
<ul>
<li><code>non-docker</code> 버전으로 아래와 같이 실행을 하던지,</li>
</ul>
<pre><code class="language-shell">$ vault server -config=config.hcl
$ vault operator init
</code></pre>
<ul>
<li><code>docker</code> 버전으로 아래와 같이 실행을 하자.</li>
</ul>
<pre><code class="language-shell">#config init
$ docker run
 --cap-add=IPC_LOCK
 -e 'VAULT_LOCAL_CONFIG={&quot;backend&quot;: {&quot;file&quot;: {&quot;path&quot;: &quot;/vault/file&quot;}}, &quot;listener&quot;: {&quot;tcp&quot;: { &quot;address&quot;: &quot;0.0.0.0:8200&quot;, &quot;tls_disable&quot;: &quot;true&quot;}}, &quot;ui&quot;: &quot;true&quot;, &quot;default_lease_ttl&quot;: &quot;168h&quot;, &quot;max_lease_ttl&quot;: &quot;720h&quot;}'
 -d
 -p 8200:8200
 --name=dev-vault
 docker.io/vault:1.1.2 server
</code></pre>
<h4 id="unseal"><a class="toclink" href="../../../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#unseal">Unseal 을 해보자</a></h4>
<p>초기에 vault 가 실행되거나 재기동이 되면 <code>sealed</code> 상태가 되어 사용할 수 없게 된다.<br />
이때 사용할 수 있는 명령은 <code>status</code>, <code>operator init</code> 뿐인듯.<br />
<code>unseal key</code> 5개 중 아무거나 3개로 unseal 하여 사용하자.<br />
<code>root key</code> 는 잘 숨겨놓자.</p>
<pre><code class="language-shell"># 아래키는 여러번 실행해본 docker 버전의 vault 의 키 중 하나이다.
Unseal Key 1: zmQlHaFap7yo/onSXDLGtzUQwz/cgNc3igd7dvSsPl9M
Unseal Key 2: 0R1XXjz2szSJW3q05eapTs2ST6npYsHROHEr0l1aMyez
Unseal Key 3: 5YwtvQcIP+VzX/TMkb0UDSaw+R9ZDftx3eDAmHn7Tn8Q
Unseal Key 4: 45mBEZsh4dC71EUq2SXgC7owz3NFx04cqaQEMlDp1Yqo
Unseal Key 5: HP18QROkknaL8ZAyMFfMZmBh/cxuKfUiq/Zx9nOlW8Bj

Initial Root Token: s.syVRoWESdXjZU0iaPDXROlEv

$ vault operator unseal
Unseal Key (will be hidden):
</code></pre>
<h2 id="_7"><a class="toclink" href="../../../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#_7">이제 설치 끝! 사용해보자</a></h2>
<h4 id="secret-engine"><a class="toclink" href="../../../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#secret-engine">secret engine 을 활성화 하자</a></h4>
<p>단순하게 사용할거니까 <code>KV Secrets Engine</code> 를 활성화 시킨다.<br />
버전이 두개가 있으므로 둘다 써보자.</p>
<blockquote>
<p>Version 1 과 Version 2 의 차이점은 K/V 의 버전 유무다. Version 2 는 K/V 셋의 버전을 관리해준다.</p>
</blockquote>
<pre><code class="language-shell">$ vault secrets enable -version=1 -path=my-secret1 kv
Success! Enabled the kv secrets engine at: my-secret1/

$ vault secrets enable -version=2 -path=my-secret2 kv
Success! Enabled the kv secrets engine at: my-secret2/
</code></pre>
<h4 id="secret-engine_1"><a class="toclink" href="../../../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#secret-engine_1">활성화한 secret engine 에 데이터를 써보자</a></h4>
<blockquote>
<p>Version 1 에선 <code>read/write</code> 또는 <code>kv get/put</code>명령어를 사용했지만, Version 2 에선 <code>kv get/put</code> 만 사용한다고 한다.</p>
</blockquote>
<p>먼저 <code>version 1</code> 부터</p>
<pre><code class="language-shell">$ vault write my-secret1/hello foo=bar
Success! Data written to: my-secret1/hello

$ vault read my-secret1/hello
Key                 Value
---                 -----
refresh_interval    168h
foo                 bar

$ vault write my-secret1/hello hello=world
Success! Data written to: my-secret1/hello

$ vault read my-secret1/hello
Key                 Value
---                 -----
refresh_interval    168h
hello               world

$ vault write my-secret1/hello foo=bar hello=world
Success! Data written to: my-secret1/hello

$ vault read my-secret1/hello
Key                 Value
---                 -----
refresh_interval    168h
foo                 bar
hello               world
</code></pre>
<p>그 다음은 <code>version 2</code></p>
<pre><code class="language-shell">$ vault kv put my-secret2/hello bar=foo
Key              Value
---              -----
created_time     2019-09-17T14:10:37.317296459Z
deletion_time    n/a
destroyed        false
version          1

# Version 1 과 달리 version 정보가 포함된 metadata 가 보인다

$ vault kv get my-secret2/hello
====== Metadata ======
Key              Value
---              -----
created_time     2019-09-17T14:10:37.317296459Z
deletion_time    n/a
destroyed        false
version          1

=== Data ===
Key    Value
---    -----
bar    foo

$ vault kv put my-secret2/hello world=hello bar=foo
Key              Value
---              -----
created_time     2019-09-17T14:13:25.68859452Z
deletion_time    n/a
destroyed        false
version          2

# version 정보가 2로 올라간다.

$ vault kv get my-secret2/hello
====== Metadata ======
Key              Value
---              -----
created_time     2019-09-17T14:13:25.68859452Z
deletion_time    n/a
destroyed        false
version          2

==== Data ====
Key      Value
---      -----
bar      foo
world    hello

# version 을 명시하여 가져올 수 도 있다.

$ vault kv get -version=1 my-secret2/hello
====== Metadata ======
Key              Value
---              -----
created_time     2019-09-17T14:10:37.317296459Z
deletion_time    n/a
destroyed        false
version          1

=== Data ===
Key    Value
---    -----
bar    foo

</code></pre>
<h4 id="secret-engine_2"><a class="toclink" href="../../../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#secret-engine_2">secret engine 비활성화</a></h4>
<pre><code class="language-shell">$ vault secrets enable -version=1 -path=temp kv
Success! Enabled the kv secrets engine at: temp/

$ vault secrets disable temp
Success! Disabled the secrets engine (if it existed) at: temp/
</code></pre>
<h3 id="token"><a class="toclink" href="../../../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#token">TOKEN 을 사용해보자</a></h3>
<h4 id="hcl"><a class="toclink" href="../../../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#hcl">정책 파일 .hcl 작성</a></h4>
<blockquote>
<p><code>.hcl</code> 확장자는 <code>Hashicorp Configuration Language</code> 를 의미함</p>
</blockquote>
<p><code>Version 1</code> 과 <code>Version 2</code> 에 대한 다른 정책을 기반으로 다른 두 토큰을 만들 예정이므로, <code>Version 1</code> 인 <code>my-secret1/*</code> 에 접근할 <code>my-policy1.hcl</code> 와 <code>Version 2</code> 인 <code>my-secret2/*</code> 에 접근할 <code>my-policy2.hcl</code> 을 만든다.</p>
<blockquote>
<p>my-policy1.hcl</p>
</blockquote>
<pre><code>path &quot;my-secret1/*&quot; {
  capabilities = [&quot;create&quot;, &quot;read&quot;, &quot;update&quot;, &quot;delete&quot;, &quot;list&quot;]
}
</code></pre>
<blockquote>
<p>my-policy2.hcl</p>
</blockquote>
<pre><code>path &quot;my-secret2/*&quot; {
  capabilities = [&quot;create&quot;, &quot;read&quot;, &quot;update&quot;, &quot;delete&quot;, &quot;list&quot;]
}
</code></pre>
<h4 id="_8"><a class="toclink" href="../../../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#_8">정책파일을 업로드 한다.</a></h4>
<p>업로드 하기 전 정합성 체크를 한다.</p>
<pre><code class="language-shell">$ vault policy fmt my-policy1.hcl
Success! Formatted policy: my-policy1.hcl

$ vault policy fmt my-policy2.hcl
Success! Formatted policy: my-policy2.hcl
</code></pre>
<p>정합성이 확인된 파일로 <code>my-policy</code> 란 이름으로 정책을 만든다.</p>
<pre><code class="language-shell">$ vault policy write my-policy1 ./my-policy1.hcl
Success! Uploaded policy: my-policy1

$ vault policy write my-policy2 my-policy2.hcl
Success! Uploaded policy: my-policy2
</code></pre>
<p>만들어진 정책을 확인해본다.</p>
<pre><code class="language-shell">$ vault policy list
default
my-policy1
my-policy2
root

$ vault policy read my-policy1
path &quot;my-secret1/*&quot; {
  capabilities = [&quot;create&quot;, &quot;read&quot;, &quot;update&quot;, &quot;delete&quot;, &quot;list&quot;]
}

</code></pre>
<h4 id="_9"><a class="toclink" href="../../../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#_9">만든 정책으로 토큰을 발급해본다</a></h4>
<pre><code class="language-shell">$ vault token create -policy=my-policy1
Key                  Value
---                  -----
token                s.Jb0UpJBV0bdtWYO8TxlDwphk
token_accessor       V8cFQMqcGSJihrFDbIzkBBqG
token_duration       168h
token_renewable      true
token_policies       [&quot;default&quot; &quot;my-policy1&quot;]
identity_policies    []
policies             [&quot;default&quot; &quot;my-policy1&quot;]

$ vault token create -policy=my-policy2
Key                  Value
---                  -----
token                s.BnRO5kDRZTAHHRMvZIk8qwia
token_accessor       90iSQdmmxhYSFaVq0CX4uSKb
token_duration       168h
token_renewable      true
token_policies       [&quot;default&quot; &quot;my-policy2&quot;]
identity_policies    []
policies             [&quot;default&quot; &quot;my-policy2&quot;]
</code></pre>
<h4 id="_10"><a class="toclink" href="../../../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#_10">발급한 토큰을 사용해보자</a></h4>
<ol>
<li>토큰 로그인</li>
<li>정책상의 경로로 <code>write</code>, <code>kv put</code></li>
<li>정책상의 경로로 <code>read</code>, <code>kv get</code></li>
<li>정책에 없는 경로로 <code>read</code>, <code>kv get</code></li>
</ol>
<p><code>Version 1</code> 부터 해본다.</p>
<pre><code class="language-shell"># 로그인
$ vault login s.Jb0UpJBV0bdtWYO8TxlDwphk
Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run &quot;vault login&quot;
again. Future Vault requests will automatically use this token.

Key                  Value
---                  -----
token                s.Jb0UpJBV0bdtWYO8TxlDwphk
token_accessor       V8cFQMqcGSJihrFDbIzkBBqG
token_duration       167h52m53s
token_renewable      true
token_policies       [&quot;default&quot; &quot;my-policy1&quot;]
identity_policies    []
policies             [&quot;default&quot; &quot;my-policy1&quot;]

# version 1 에선 read/write 명령어가 된다
$ vault write my-secret1/hello world=1
Success! Data written to: my-secret1/hello

# 데이터 확인
$ vault read my-secret1/hello
Key                 Value
---                 -----
refresh_interval    168h
world               1

# version 1 에선 kv get/put 도 된다.
$ vault kv put my-secret1/hello world=2 foo=bar
Success! Data written to: my-secret1/hello

# 데이터 확인
$ vault kv get my-secret1/hello
==== Data ====
Key      Value
---      -----
foo      bar
world    2

# 정책상에 없는 경로 접근
$ vault read my-secret2/hello
Error reading my-secret2/hello: Error making API request.

URL: GET http://127.0.0.1:8200/v1/my-secret2/hello
Code: 403. Errors:

* 1 error occurred:
        * permission denied
</code></pre>
<p>이번엔 <code>Version 2</code></p>
<pre><code class="language-shell"># 로그인
$ vault login s.BnRO5kDRZTAHHRMvZIk8qwia
Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run &quot;vault login&quot;
again. Future Vault requests will automatically use this token.

Key                  Value
---                  -----
token                s.BnRO5kDRZTAHHRMvZIk8qwia
token_accessor       90iSQdmmxhYSFaVq0CX4uSKb
token_duration       167h50m9s
token_renewable      true
token_policies       [&quot;default&quot; &quot;my-policy2&quot;]
identity_policies    []
policies             [&quot;default&quot; &quot;my-policy2&quot;]

# version 2 에선 read/write 명령을 사용할 수 없다.
$ vault write my-secret2/hello world=1
Error writing data to my-secret2/hello: Error making API request.

URL: PUT http://127.0.0.1:8200/v1/my-secret2/hello
Code: 404. Errors:


WARNING! The following warnings were returned from Vault:

  * Invalid path for a versioned K/V secrets engine. See the API docs for the
  appropriate API endpoints to use. If using the Vault CLI, use 'vault kv put'
  for this operation.

# 마찬가지
$ vault read my-secret2/hello
WARNING! The following warnings were returned from Vault:

  * Invalid path for a versioned K/V secrets engine. See the API docs for the
  appropriate API endpoints to use. If using the Vault CLI, use 'vault kv get'
  for this operation.

# 버전이 보인다. 이전에 몇번 데이터를 넣어서 버전이 3 이다.
$ vault kv put my-secret2/hello world=1
Key              Value
---              -----
created_time     2019-09-18T08:38:14.993018446Z
deletion_time    n/a
destroyed        false
version          3

# 데이터 확인
$ vault kv get my-secret2/hello
====== Metadata ======
Key              Value
---              -----
created_time     2019-09-18T08:38:14.993018446Z
deletion_time    n/a
destroyed        false
version          3

==== Data ====
Key      Value
---      -----
world    1

# 정책에 없는 경로로 접근
$ vault kv get my-secret1/hello
Error making API request.

URL: GET http://127.0.0.1:8200/v1/sys/internal/ui/mounts/my-secret1/hello
Code: 403. Errors:

* preflight capability check returned 403, please ensure client's policies grant access to path &quot;my-secret1/hello/&quot;
</code></pre>
<blockquote>
<p>K/V Version 2 에선 secret engine 뒤에 data 가 붙는다고 한다. Version 1 에선 필요 없지만 Version 2 에선 data 를 붙여줘야 한다.</p>
</blockquote>
<h4 id="_11"><a class="toclink" href="../../../../2019/09/17/vault-%EB%A7%9B%EB%B3%B4%EA%B8%B0/#_11">발급 토큰 삭제</a></h4>
<pre><code class="language-shell"># 둘다 없애고
$ vault token revoke s.Jb0UpJBV0bdtWYO8TxlDwphk
Success! Revoked token (if it existed)

$ vault token revoke s.BnRO5kDRZTAHHRMvZIk8qwia
Success! Revoked token (if it existed)

# 로그인하려면 실패한다.
$ vault login s.BnRO5kDRZTAHHRMvZIk8qwia
Error authenticating: error looking up token: Error making API request.

URL: GET http://127.0.0.1:8200/v1/auth/token/lookup-self
Code: 403. Errors:

* permission denied
</code></pre>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  <a class="md-pagination__link" href="../../">1</a> <a class="md-pagination__link" href="../2/">2</a> <span class="md-pagination__current">3</span> <a class="md-pagination__link" href="../4/">4</a> <a class="md-pagination__link" href="../5/">5</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../8/">8</a>
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../../../..", "features": [], "search": "../../../../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": {"Compatibility": "compat", "rabbitmq": "rabbitmq"}, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.f13b1293.min.js"></script>
      
    
  </body>
</html>